<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO App - Task Manager (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .column {
            min-height: 400px;
            transition: background-color 0.2s ease;
        }
        .column.bg-blue-50 {
            background-color: rgba(239, 246, 255, 0.6);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .column {
                min-height: 200px;
            }

            /* Stack columns vertically on mobile */
            .kanban-board {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            /* Make header more compact */
            header h1 {
                font-size: 1.5rem !important;
            }

            header p {
                font-size: 0.75rem !important;
            }

            /* Hide some text on very small screens */
            .hide-mobile-text {
                display: none;
            }

            /* Make buttons more touch-friendly */
            button {
                min-height: 44px;
            }

            /* Adjust stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Single column for filters on mobile */
            .filters-grid {
                grid-template-columns: 1fr !important;
            }

            /* Make modals full screen on mobile */
            .modal-content {
                width: 100vw !important;
                height: 100vh !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
        }

        /* ========== ANIMATIONS ========== */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out;
        }

        .animate-slideUp {
            animation: slideUp 0.3s ease-out;
        }

        .animate-scaleIn {
            animation: scaleIn 0.2s ease-out;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }

        /* Modal backdrop animations */
        .modal-backdrop:not(.hidden) {
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            animation: scaleIn 0.3s ease-out;
        }

        /* Input Validation Styles */
        .input-valid {
            border-color: #10b981 !important;
            background-color: #f0fdf4;
        }

        .input-invalid {
            border-color: #ef4444 !important;
            background-color: #fef2f2;
        }

        .validation-message {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            margin-top: 0.375rem;
        }

        .validation-message.success {
            color: #10b981;
        }

        .validation-message.error {
            color: #ef4444;
        }

        .validation-message.warning {
            color: #f59e0b;
        }

        .char-counter {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 0.25rem;
        }

        .char-counter.warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .char-counter.error {
            color: #ef4444;
            font-weight: 600;
        }

        /* Tag Badges */
        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.375rem;
            margin-bottom: 0.375rem;
            transition: all 0.2s ease;
        }

        .tag-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        /* Tag color variants */
        .tag-work {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .tag-personal {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .tag-urgent {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .tag-meeting {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .tag-default {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        /* Modern Gradient Background with Blurred Glows */
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(
                circle at 20% 20%,
                #1e293b 0%,
                #0f172a 35%,
                #020617 100%
            );
            font-family: "Inter", system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Blurred glow effects */
        body::before {
            content: "";
            position: fixed;
            top: -10%;
            left: -10%;
            width: 40vw;
            height: 40vw;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            filter: blur(150px);
            opacity: 0.2;
            border-radius: 50%;
            z-index: -1;
            pointer-events: none;
        }

        body::after {
            content: "";
            position: fixed;
            bottom: -10%;
            right: -10%;
            width: 40vw;
            height: 40vw;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            filter: blur(150px);
            opacity: 0.2;
            border-radius: 50%;
            z-index: -1;
            pointer-events: none;
        }

        /* Override Tailwind's bg-gray-100 */
        body.bg-gray-100 {
            background: radial-gradient(
                circle at 20% 20%,
                #1e293b 0%,
                #0f172a 35%,
                #020617 100%
            ) !important;
        }

        /* Dark Theme */
        body.dark-theme {
            background: radial-gradient(
                circle at 20% 20%,
                #1e293b 0%,
                #0f172a 35%,
                #020617 100%
            ) !important;
            color: #e2e8f0;
        }
        body.dark-theme header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        body.dark-theme .bg-white {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark-theme .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark-theme .text-gray-800 {
            color: #e2e8f0;
        }
        body.dark-theme .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-theme .text-gray-500 {
            color: #718096;
        }
        body.dark-theme .bg-gray-50 {
            background-color: #374151;
        }
        body.dark-theme .border-gray-200,
        body.dark-theme .border-gray-300 {
            border-color: #4a5568;
        }
        body.dark-theme input,
        body.dark-theme textarea,
        body.dark-theme select {
            background-color: #374151;
            color: #e2e8f0;
            border-color: #4a5568;
        }

        /* Top-right green account pill */
        .account-header {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        /* Dark gray pill button */
        .account-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #475569, #334155);
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(71, 85, 105, 0.4);
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s ease;
        }

        .account-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(71, 85, 105, 0.5);
            filter: brightness(1.15);
        }

        .account-arrow {
            font-size: 0.75rem;
            opacity: 0.85;
        }

        /* Dropdown */
        .account-menu {
            position: absolute;
            top: 2.6rem;
            right: 0;
            min-width: 180px;
            border-radius: 0.85rem;
            padding: 0.4rem;
            background: #020617;
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: 0 18px 42px rgba(15, 23, 42, 0.9);
            display: none;
        }

        .account-menu.open {
            display: block;
        }

        .account-menu-item {
            width: 100%;
            padding: 0.55rem 0.75rem;
            border-radius: 0.6rem;
            border: none;
            background: transparent;
            color: #e5e7eb;
            font-size: 0.85rem;
            text-align: left;
            cursor: pointer;
            transition: background 0.12s ease, color 0.12s ease;
        }

        .account-menu-item:hover {
            background: rgba(34, 197, 94, 0.12);
            color: #bbf7d0;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }

        .modal-backdrop.open {
            display: flex;
        }

        .modal {
            background: #020617;
            border-radius: 1rem;
            padding: 1.8rem;
            width: 100%;
            max-width: 380px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow: 0 20px 55px rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
        }

        .modal h2 {
            margin: 0 0 1rem;
            font-size: 1.05rem;
        }

        .modal label {
            display: block;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
        }

        .modal label span {
            display: block;
            margin-bottom: 0.25rem;
            color: #9ca3af;
        }

        .modal input {
            width: 100%;
            padding: 0.5rem 0.65rem;
            border-radius: 0.6rem;
            border: 1px solid #1f2937;
            background: #020617;
            color: #e5e7eb;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .modal-actions button {
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            border: 1px solid #4b5563;
            background: transparent;
            color: #e5e7eb;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .modal-actions .primary {
            border: none;
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

    </style>
</head>
<body class="bg-gray-100">
    <!-- Header (hidden until logged in) -->
    <header id="app-header" class="bg-blue-600 text-white shadow-lg" style="display:none;">
        <div class="container mx-auto px-4 py-4 md:py-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-0">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">üìã TaskFlow</h1>
                    <p class="text-blue-100 mt-1 text-sm md:text-base">Organize your tasks efficiently</p>
                </div>
                <div class="w-full md:w-auto flex flex-wrap items-center gap-2 md:gap-4">
                    <button onclick="openBadgesModal()" class="bg-blue-500 hover:bg-blue-700 px-3 md:px-4 py-2 rounded-lg transition-colors text-sm md:text-base">
                        üèÜ<span class="hidden sm:inline"> Achievements</span>
                    </button>
                    <div class="flex-1 md:flex-none text-left md:text-right">
                        <div id="streakDisplay" class="text-lg md:text-2xl font-bold">üî• 0 day streak</div>
                        <div id="todayTasksDisplay" class="text-xs md:text-sm text-blue-100 mt-1">0 tasks completed today</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4">
        <!-- Authentication Section -->
        <section id="auth-section" class="flex items-center justify-center min-h-[80vh]">
            <div class="w-full max-w-md">
                <!-- Login/Register Forms (shown when not logged in) -->
                <div id="auth-forms">
                    <!-- Welcome Header with Glassmorphism -->
                    <div class="text-center mb-8">
                        <div class="inline-block p-4 bg-gradient-to-br from-blue-500/20 to-indigo-500/20 backdrop-blur-sm rounded-2xl border border-white/20 shadow-2xl mb-6">
                            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">üìã</h1>
                        </div>
                        <h2 class="text-4xl font-bold text-white mb-3 drop-shadow-lg">TaskFlow</h2>
                        <p class="text-blue-200 text-lg">Organize your tasks efficiently with cloud sync</p>
                    </div>

                    <!-- Unified Auth Form with Glassmorphism -->
                    <div class="bg-white/10 backdrop-blur-md rounded-2xl shadow-2xl border border-white/20 overflow-hidden">
                        <!-- Tab Navigation -->
                        <div class="flex border-b border-white/10">
                            <button id="login-tab" class="flex-1 px-6 py-4 text-center font-semibold text-white border-b-2 border-blue-400 transition-all hover:bg-white/5">
                                <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                </svg>
                                Login
                            </button>
                            <button id="register-tab" class="flex-1 px-6 py-4 text-center font-semibold text-blue-200 border-b-2 border-transparent transition-all hover:bg-white/5 hover:text-white">
                                <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                </svg>
                                Create Account
                            </button>
                        </div>

                        <!-- Tab Content -->
                        <div class="p-8">
                        <!-- Login Form -->
                        <div id="login-form">
                            <form id="loginForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-blue-100 mb-2">Email Address</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                            </svg>
                                        </div>
                                        <input
                                            id="login-email"
                                            type="email"
                                            placeholder="you@example.com"
                                            required
                                            class="w-full pl-10 pr-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 text-white placeholder-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 focus:bg-white/20 transition-all">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-blue-100 mb-2">Password</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                        </div>
                                        <input
                                            id="login-password"
                                            type="password"
                                            placeholder="Enter your password"
                                            required
                                            class="w-full pl-10 pr-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 text-white placeholder-blue-200 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400 focus:bg-white/20 transition-all">
                                    </div>
                                </div>
                                <button
                                    id="login-btn"
                                    type="submit"
                                    class="w-full bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-6 py-3.5 rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all font-bold shadow-xl hover:shadow-2xl transform hover:-translate-y-0.5 border border-blue-400/30">
                                    <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                                    </svg>
                                    Sign In
                                </button>
                            </form>
                        </div>

                        <!-- Register Form -->
                        <div id="register-form" style="display:none;">
                            <form id="registerForm" class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-blue-100 mb-2">Username</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <input
                                            id="register-username"
                                            type="text"
                                            placeholder="john_doe"
                                            required
                                            minlength="3"
                                            maxlength="30"
                                            pattern="[a-zA-Z0-9_-]+"
                                            class="w-full pl-10 pr-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 text-white placeholder-blue-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400 focus:bg-white/20 transition-all">
                                    </div>
                                    <p class="mt-2 text-xs text-blue-200">3-30 characters: letters, numbers, underscore, hyphen</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-blue-100 mb-2">Email Address</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                                            </svg>
                                        </div>
                                        <input
                                            id="register-email"
                                            type="email"
                                            placeholder="you@example.com"
                                            required
                                            class="w-full pl-10 pr-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 text-white placeholder-blue-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400 focus:bg-white/20 transition-all">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-blue-100 mb-2">Password</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <svg class="h-5 w-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                            </svg>
                                        </div>
                                        <input
                                            id="register-password"
                                            type="password"
                                            placeholder="Minimum 6 characters"
                                            required
                                            minlength="6"
                                            class="w-full pl-10 pr-4 py-3 bg-white/10 backdrop-blur-sm border border-white/20 text-white placeholder-blue-200 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400 focus:bg-white/20 transition-all">
                                    </div>
                                    <p class="mt-2 text-xs text-blue-200">Must be at least 6 characters long</p>
                                </div>
                                <button
                                    id="register-btn"
                                    type="submit"
                                    class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3.5 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all font-bold shadow-xl hover:shadow-2xl transform hover:-translate-y-0.5 border border-green-400/30">
                                    <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                    </svg>
                                    Create Account
                                </button>
                            </form>
                        </div>
                    </div>
                </div>


                <!-- Auth Error Message -->
                <div id="auth-error" class="mt-6 hidden">
                    <div class="bg-red-500/20 border border-red-400/50 backdrop-blur-sm p-4 rounded-lg">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-300 mr-3" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                            <p class="text-white text-sm font-medium"></p>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </section>

        <!-- App Container (hidden until logged in) -->
        <div id="app-container" style="display:none;" class="mt-4">
        <!-- Stats Dashboard -->
        <div class="stats-grid grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4">
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">Total Tasks</p>
                        <p id="statTotal" class="text-2xl md:text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="text-3xl md:text-4xl">üìù</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">Completed</p>
                        <p id="statCompleted" class="text-2xl md:text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="text-3xl md:text-4xl">‚úÖ</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">In Progress</p>
                        <p id="statInProgress" class="text-2xl md:text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-3xl md:text-4xl">‚ö°</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">Completion Rate</p>
                        <p id="statRate" class="text-2xl md:text-3xl font-bold text-purple-600">0%</p>
                    </div>
                    <div class="text-3xl md:text-4xl">üìà</div>
                </div>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-4">
            <div class="filters-grid grid grid-cols-1 md:grid-cols-5 gap-3 md:gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Tasks</label>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search by title..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Priority</label>
                    <select
                        id="filterPriority"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Priorities</option>
                        <option value="high">üî¥ High Only</option>
                        <option value="medium">üü° Medium Only</option>
                        <option value="low">üü¢ Low Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                    <select
                        id="filterStatus"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Statuses</option>
                        <option value="todo">To Do Only</option>
                        <option value="in_progress">In Progress Only</option>
                        <option value="done">Done Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Filters</label>
                    <select
                        id="filterQuick"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Tasks</option>
                        <option value="today">üìÖ Due Today</option>
                        <option value="overdue">‚ö†Ô∏è Overdue</option>
                        <option value="upcoming">üîî Upcoming</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Tag</label>
                    <select
                        id="filterTag"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Tags</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row gap-2">
                <button onclick="clearFilters()" class="w-full sm:w-auto px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm font-medium">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Two-Column Layout: Add Task (Left) + Task Board (Right) -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-4">
            <!-- Left Column: Add Task Panel -->
            <div class="lg:col-span-4">
                <div class="bg-white rounded-xl shadow-lg p-8 sticky top-6">
                    <div class="flex items-center mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">Add New Task</h2>
                    </div>
                    <form id="addTaskForm" class="space-y-5">
                        <div>
                            <label for="taskTitle" class="block text-sm font-semibold text-gray-700 mb-2">Task Title *</label>
                            <input
                                type="text"
                                id="taskTitle"
                                required
                                maxlength="100"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base"
                                placeholder="What needs to be done?">
                            <div id="taskTitleValidation" class="validation-message" style="display: none;">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span id="taskTitleValidationText"></span>
                            </div>
                            <div id="taskTitleCounter" class="char-counter">0 / 100 characters</div>
                        </div>
                        <div>
                            <label for="taskDescription" class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                            <textarea
                                id="taskDescription"
                                rows="4"
                                maxlength="500"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-none text-base"
                                placeholder="Add more details (optional)..."></textarea>
                            <div id="taskDescriptionCounter" class="char-counter">0 / 500 characters</div>
                        </div>
                        <div>
                            <label for="taskPriority" class="block text-sm font-semibold text-gray-700 mb-2">Priority</label>
                            <select
                                id="taskPriority"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base">
                                <option value="low">üü¢ Low Priority</option>
                                <option value="medium" selected>üü° Medium Priority</option>
                                <option value="high">üî¥ High Priority</option>
                            </select>
                        </div>
                        <div>
                            <label for="taskTags" class="block text-sm font-semibold text-gray-700 mb-2">Tags</label>
                            <input
                                type="text"
                                id="taskTags"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base"
                                placeholder="work, urgent, personal (comma-separated)">
                            <p class="mt-1 text-xs text-gray-500">Separate tags with commas. Popular: work, personal, urgent, meeting</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="taskDueDate" class="block text-sm font-semibold text-gray-700 mb-2">Due Date</label>
                                <input
                                    type="date"
                                    id="taskDueDate"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base">
                            </div>
                            <div>
                                <label for="taskDueTime" class="block text-sm font-semibold text-gray-700 mb-2">Time</label>
                                <input
                                    type="time"
                                    id="taskDueTime"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base">
                            </div>
                        </div>
                        <button
                            type="submit"
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3.5 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all font-semibold text-base shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                            <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Task
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Task Board -->
            <div class="lg:col-span-8">
                <!-- Quick Add Bar -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-5 border-2 border-blue-100">
                    <form id="quickAddForm" class="flex gap-3">
                        <input
                            type="text"
                            id="quickTaskTitle"
                            placeholder="‚ö° Quick add: Type task and press Enter..."
                            class="flex-1 px-4 py-2.5 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-base bg-white"
                        />
                        <select id="quickTaskPriority" class="px-3 py-2.5 border-2 border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white text-sm">
                            <option value="low">üü¢ Low</option>
                            <option value="medium" selected>üü° Medium</option>
                            <option value="high">üî¥ High</option>
                        </select>
                        <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all font-semibold shadow-md hover:shadow-lg">
                            <svg class="w-5 h-5 inline-block -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </form>
                    <p class="text-xs text-blue-600 mt-2 ml-1">üí° Tip: Press <kbd class="px-2 py-0.5 bg-white border border-blue-200 rounded text-xs font-mono">N</kbd> from anywhere to add a task</p>
                </div>

                <div class="kanban-board grid grid-cols-1 md:grid-cols-3 gap-5">
            <!-- TODO Column -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-gray-400">
                <div class="flex items-center mb-5">
                    <div class="w-4 h-4 bg-gray-400 rounded-full mr-3 shadow-sm"></div>
                    <h3 class="text-xl font-bold text-gray-800">To Do</h3>
                    <span id="todoCount" class="ml-auto bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                </div>
                <div id="todoColumn" class="column space-y-4 min-h-[400px]">
                    <!-- Empty state -->
                    <div class="empty-state text-center py-12 px-4 opacity-60">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p class="text-gray-400 font-medium">No tasks yet</p>
                        <p class="text-xs text-gray-300 mt-2">Add your first task using the form ‚Üê</p>
                    </div>
                </div>
            </div>

            <!-- IN PROGRESS Column -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-blue-500">
                <div class="flex items-center mb-5">
                    <div class="w-4 h-4 bg-blue-500 rounded-full mr-3 shadow-sm"></div>
                    <h3 class="text-xl font-bold text-gray-800">In Progress</h3>
                    <span id="inProgressCount" class="ml-auto bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                </div>
                <div id="inProgressColumn" class="column space-y-4 min-h-[400px]">
                    <!-- Empty state -->
                    <div class="empty-state text-center py-12 px-4 opacity-60">
                        <svg class="w-16 h-16 mx-auto text-blue-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <p class="text-gray-400 font-medium">Nothing in progress</p>
                        <p class="text-xs text-gray-300 mt-2">Start working on a task!</p>
                    </div>
                </div>
            </div>

            <!-- DONE Column -->
            <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-green-500">
                <div class="flex items-center mb-5">
                    <div class="w-4 h-4 bg-green-500 rounded-full mr-3 shadow-sm"></div>
                    <h3 class="text-xl font-bold text-gray-800">Done</h3>
                    <span id="doneCount" class="ml-auto bg-green-50 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">0</span>
                </div>
                <div id="doneColumn" class="column space-y-4 min-h-[400px]">
                    <!-- Empty state -->
                    <div class="empty-state text-center py-12 px-4 opacity-60">
                        <svg class="w-16 h-16 mx-auto text-green-200 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-gray-400 font-medium">No completed tasks</p>
                        <p class="text-xs text-gray-300 mt-2">Completed tasks will appear here!</p>
                    </div>
                </div>
            </div>
        </div>
                </div><!-- End of right column -->
            </div><!-- End of two-column layout -->
        </div><!-- End of app-container -->
    </main>

    <!-- Edit Task Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Edit Task</h2>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="editTaskForm" class="space-y-4">
                <input type="hidden" id="editTaskId">
                <div>
                    <label for="editTaskTitle" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                    <input
                        type="text"
                        id="editTaskTitle"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter task title...">
                </div>
                <div>
                    <label for="editTaskDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                    <textarea
                        id="editTaskDescription"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter task description..."></textarea>
                </div>
                <div>
                    <label for="editTaskPriority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select
                        id="editTaskPriority"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="low">üü¢ Low Priority</option>
                        <option value="medium">üü° Medium Priority</option>
                        <option value="high">üî¥ High Priority</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editTaskDueDate" class="block text-sm font-medium text-gray-700 mb-1">Due Date (Optional)</label>
                        <input
                            type="date"
                            id="editTaskDueDate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="editTaskDueTime" class="block text-sm font-medium text-gray-700 mb-1">Due Time (Optional)</label>
                        <input
                            type="time"
                            id="editTaskDueTime"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button
                        type="submit"
                        class="flex-1 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Save Changes
                    </button>
                    <button
                        type="button"
                        onclick="closeEditModal()"
                        class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 animate-fadeIn">
        <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md transform transition-all">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Delete Task?</h2>
                <p class="text-gray-600">Are you sure you want to delete this task? This action cannot be undone.</p>
            </div>
            <div class="flex gap-3">
                <button
                    onclick="closeDeleteConfirmModal()"
                    class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-all font-semibold">
                    Cancel
                </button>
                <button
                    id="confirmDeleteBtn"
                    class="flex-1 bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-3 rounded-lg hover:from-red-700 hover:to-red-800 transition-all font-semibold shadow-lg hover:shadow-xl">
                    Delete Task
                </button>
            </div>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div id="themeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üé® Choose Theme</h2>
                <button onclick="closeThemeModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-3">
                <button onclick="setTheme('default')" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-blue-500 transition-all flex items-center gap-3">
                    <div class="text-2xl">üåå</div>
                    <div class="text-left flex-1">
                        <h3 class="font-bold">Default Theme</h3>
                        <p class="text-sm text-gray-600">Modern gradient with glows</p>
                    </div>
                    <div id="default-check" class="text-green-500">‚úì</div>
                </button>
                <button onclick="setTheme('dark')" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-blue-500 transition-all flex items-center gap-3">
                    <div class="text-2xl">üåô</div>
                    <div class="text-left flex-1">
                        <h3 class="font-bold">Dark Theme</h3>
                        <p class="text-sm text-gray-600">Easy on the eyes</p>
                    </div>
                    <div id="dark-check" class="hidden text-green-500">‚úì</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Badges/Achievements Modal -->
    <div id="badgesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üèÜ Your Achievements</h2>
                <button onclick="closeBadgesModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="badgesContent" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Badges will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-all">
        <p id="toastMessage">Success!</p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase SDKs from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            setDoc,
            getDoc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            query,
            where,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        // Firebase web app configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSmStArK27afXhD73uJ2FuEkmOPe-pEqc",
            authDomain: "todo-app-47601.firebaseapp.com",
            projectId: "todo-app-47601",
            storageBucket: "todo-app-47601.firebasestorage.app",
            messagingSenderId: "756457875678",
            appId: "1:756457875678:web:fbd8155a9d91e211f57a4f",
            measurementId: "G-5JDJFZHNPL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose Firebase instances globally for other scripts
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCore = { auth, db };
        window.firebaseFunctions = {
            collection,
            doc,
            setDoc,
            getDoc,
            addDoc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            query,
            where,
            serverTimestamp
        };

        console.log("Firebase initialized successfully");
    </script>

    <script>
        // Firebase-based Task Manager

        // State
        let tasks = [];
        let nextId = 1;
        let streakData = {
            currentStreak: 0,
            lastCompletionDate: null,
            todayCompletions: 0
        };

        // Filter state
        let filters = {
            search: '',
            priority: 'all',
            status: 'all',
            quick: 'all',
            tag: 'all'
        };

        // Current user
        let currentUser = null;

        // Firestore unsubscribe function
        let unsubscribeTasks = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for Firebase to be available
            const initApp = setInterval(() => {
                if (window.firebaseAuth && window.firebaseDb) {
                    clearInterval(initApp);

                    loadStreakData();
                    loadTheme();
                    requestNotificationPermission();
                    setupEventListeners();
                    setupDragAndDrop();
                    setupFilterListeners();
                    startNotificationChecker();

                    // Setup authentication listener
                    setupAuthListener();
                }
            }, 100);
        });

        // Setup event listeners
        function setupEventListeners() {
            const form = document.getElementById('addTaskForm');
            form.addEventListener('submit', handleAddTask);

            const quickAddForm = document.getElementById('quickAddForm');
            if (quickAddForm) {
                quickAddForm.addEventListener('submit', handleQuickAdd);
            }

            const editForm = document.getElementById('editTaskForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEditTask);
            }

            // Auth event listeners
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }

            // Tab switching event listeners
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginFormDiv = document.getElementById('login-form');
            const registerFormDiv = document.getElementById('register-form');

            if (loginTab && registerTab) {
                loginTab.addEventListener('click', () => {
                    // Switch to login tab
                    loginTab.classList.add('text-white', 'border-blue-400');
                    loginTab.classList.remove('text-blue-200', 'border-transparent');
                    registerTab.classList.add('text-blue-200', 'border-transparent');
                    registerTab.classList.remove('text-white', 'border-blue-400', 'border-green-400');

                    loginFormDiv.style.display = 'block';
                    registerFormDiv.style.display = 'none';

                    // Clear auth error
                    document.getElementById('auth-error').classList.add('hidden');
                });

                registerTab.addEventListener('click', () => {
                    // Switch to register tab
                    registerTab.classList.add('text-white', 'border-green-400');
                    registerTab.classList.remove('text-blue-200', 'border-transparent');
                    loginTab.classList.add('text-blue-200', 'border-transparent');
                    loginTab.classList.remove('text-white', 'border-blue-400');

                    registerFormDiv.style.display = 'block';
                    loginFormDiv.style.display = 'none';

                    // Clear auth error
                    document.getElementById('auth-error').classList.add('hidden');
                });
            }

            // Setup input validation listeners
            setupInputValidation();
        }

        // Setup real-time input validation
        function setupInputValidation() {
            const taskTitle = document.getElementById('taskTitle');
            const taskDescription = document.getElementById('taskDescription');
            const quickTaskTitle = document.getElementById('quickTaskTitle');

            // Task title validation
            if (taskTitle) {
                taskTitle.addEventListener('input', function() {
                    validateTaskTitle(this.value);
                });

                taskTitle.addEventListener('blur', function() {
                    if (this.value.trim().length === 0) {
                        clearValidation('taskTitle');
                    }
                });
            }

            // Task description character counter
            if (taskDescription) {
                taskDescription.addEventListener('input', function() {
                    updateCharCounter('taskDescription', this.value.length, 500);
                });
            }

            // Quick add title validation (lightweight)
            if (quickTaskTitle) {
                quickTaskTitle.addEventListener('input', function() {
                    const counter = document.createElement('div');
                    counter.className = 'char-counter';
                    counter.style.fontSize = '0.7rem';
                    counter.style.marginTop = '0.25rem';

                    if (this.value.length > 80) {
                        counter.classList.add('warning');
                        counter.textContent = `${this.value.length} / 100 characters`;

                        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('char-counter')) {
                            this.parentElement.appendChild(counter);
                        } else {
                            this.nextElementSibling.textContent = counter.textContent;
                            this.nextElementSibling.className = counter.className;
                        }
                    } else if (this.nextElementSibling && this.nextElementSibling.classList.contains('char-counter')) {
                        this.nextElementSibling.remove();
                    }
                });
            }
        }

        // Validate task title
        function validateTaskTitle(value) {
            const titleInput = document.getElementById('taskTitle');
            const validation = document.getElementById('taskTitleValidation');
            const validationText = document.getElementById('taskTitleValidationText');
            const counter = document.getElementById('taskTitleCounter');

            const length = value.trim().length;
            updateCharCounter('taskTitle', value.length, 100);

            // Clear previous states
            titleInput.classList.remove('input-valid', 'input-invalid');
            validation.className = 'validation-message';
            validation.style.display = 'none';

            if (length === 0) {
                return; // Don't show validation for empty input
            }

            if (length < 3) {
                titleInput.classList.add('input-invalid');
                validation.classList.add('error');
                validation.style.display = 'flex';
                validationText.textContent = 'Title must be at least 3 characters';
            } else if (length >= 3 && length <= 100) {
                titleInput.classList.add('input-valid');
                validation.classList.add('success');
                validation.style.display = 'flex';
                validationText.textContent = 'Looks good!';
            }
        }

        // Update character counter
        function updateCharCounter(fieldId, currentLength, maxLength) {
            const counter = document.getElementById(fieldId + 'Counter');
            if (!counter) return;

            counter.textContent = `${currentLength} / ${maxLength} characters`;

            // Remove previous warning/error classes
            counter.classList.remove('warning', 'error');

            // Add warning at 80% capacity
            if (currentLength >= maxLength * 0.8) {
                counter.classList.add('warning');
            }

            // Add error at max capacity
            if (currentLength >= maxLength) {
                counter.classList.remove('warning');
                counter.classList.add('error');
            }
        }

        // Clear validation
        function clearValidation(fieldId) {
            const input = document.getElementById(fieldId);
            const validation = document.getElementById(fieldId + 'Validation');

            if (input) {
                input.classList.remove('input-valid', 'input-invalid');
            }

            if (validation) {
                validation.style.display = 'none';
            }
        }

        // Load user profile from Firestore (defined here for use in setupAuthListener)
        async function loadUserProfile() {
            const auth = window.firebaseAuth;
            const db = window.firebaseDb;
            const { doc, getDoc } = window.firebaseFunctions;
            const user = auth.currentUser;
            if (!user) return;

            try {
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('profileUsername').value = userData.username || '';
                    document.getElementById('profileDisplayName').value = userData.displayName || '';

                    // Update account name display
                    if (userData.username) {
                        accountName.textContent = userData.username;
                    } else {
                        accountName.textContent = user.email;
                    }
                } else {
                    // No profile exists yet, show email
                    accountName.textContent = user.email;
                }

                document.getElementById('profileEmail').value = user.email;
            } catch (error) {
                console.error('Error loading profile:', error);
                // Fallback to email if error
                accountName.textContent = user.email;
            }
        }

        // Setup authentication state listener
        function setupAuthListener() {
            const auth = window.firebaseAuth;
            const { onAuthStateChanged } = window.firebaseCore;

            // This is a workaround since we can't directly import the function
            // We'll use the auth object's onAuthStateChanged method
            auth.onAuthStateChanged((user) => {
                currentUser = user;

                if (user) {
                    // User is logged in
                    console.log("User logged in:", user.email);

                    // Show header with Theme and Achievements
                    document.getElementById('app-header').style.display = 'block';

                    // Hide login/register section completely
                    document.getElementById('auth-section').style.display = 'none';

                    // Show account menu
                    accountHeader.style.display = 'flex';

                    // Load username from Firestore
                    loadUserProfile();

                    // Show the main app
                    document.getElementById('app-container').style.display = 'block';

                    // Subscribe to user's tasks
                    subscribeToTasksForCurrentUser(renderTasks);

                    // Hide auth error
                    document.getElementById('auth-error').classList.add('hidden');
                } else {
                    // User is logged out
                    console.log("User logged out");

                    // Hide header (Theme and Achievements not visible when logged out)
                    document.getElementById('app-header').style.display = 'none';

                    // Hide account menu
                    accountHeader.style.display = 'none';

                    // Show login/register section
                    document.getElementById('auth-section').style.display = 'flex';
                    document.getElementById('auth-forms').style.display = 'block';

                    // Hide the main app
                    document.getElementById('app-container').style.display = 'none';

                    // Clear tasks
                    tasks = [];

                    // Unsubscribe from tasks if subscribed
                    if (unsubscribeTasks) {
                        unsubscribeTasks();
                        unsubscribeTasks = null;
                    }
                }
            });
        }

        // Handle user registration
        async function handleRegister(e) {
            e.preventDefault();

            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;

            const authError = document.getElementById('auth-error');

            // Validate username
            if (username.length < 3) {
                authError.querySelector('p').textContent = 'Username must be at least 3 characters';
                authError.classList.remove('hidden');
                return;
            }

            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                authError.querySelector('p').textContent = 'Username can only contain letters, numbers, underscore, and hyphen';
                authError.classList.remove('hidden');
                return;
            }

            try {
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                const { doc, setDoc, serverTimestamp } = window.firebaseFunctions;

                // Import createUserWithEmailAndPassword dynamically
                const { createUserWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("User registered:", userCredential.user.email);

                // Save user profile to Firestore with username
                const userDocRef = doc(db, 'users', userCredential.user.uid);
                await setDoc(userDocRef, {
                    username: username,
                    email: email,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });

                // Clear form
                document.getElementById('register-username').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';

                showToast('Account created successfully!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                authError.querySelector('p').textContent = getAuthErrorMessage(error.code);
                authError.classList.remove('hidden');
            }
        }

        // Handle user login
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            const authError = document.getElementById('auth-error');

            try {
                const auth = window.firebaseAuth;
                // Import signInWithEmailAndPassword dynamically
                const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("User logged in:", userCredential.user.email);

                // Clear form
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';

                showToast('Logged in successfully!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                authError.querySelector('p').textContent = getAuthErrorMessage(error.code);
                authError.classList.remove('hidden');
            }
        }

        // Handle user logout
        async function handleLogout() {
            try {
                const auth = window.firebaseAuth;
                // Import signOut dynamically
                const { signOut } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");

                await signOut(auth);
                console.log("User logged out");
                showToast('Logged out successfully!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Failed to logout', 'error');
            }
        }

        // Get user-friendly auth error messages
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': 'This email is already registered. Please login instead.',
                'auth/invalid-email': 'Invalid email address.',
                'auth/operation-not-allowed': 'Email/password accounts are not enabled.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Invalid email or password.',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later.'
            };

            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        // ====================
        // STORAGE ABSTRACTION LAYER
        // ====================

        // Create a new task for the current user
        async function createTaskForCurrentUser(taskData) {
            if (!currentUser) {
                showToast('Please login to create tasks', 'error');
                return null;
            }

            try {
                const db = window.firebaseDb;
                const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                const taskToCreate = {
                    ...taskData,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                const docRef = await addDoc(collection(db, "todos"), taskToCreate);
                console.log("Task created with ID:", docRef.id);
                return { id: docRef.id, ...taskToCreate };
            } catch (error) {
                console.error("Error creating task:", error);
                showToast('Failed to create task', 'error');
                return null;
            }
        }

        // Update a task for the current user
        async function updateTaskForCurrentUser(taskId, updates) {
            if (!currentUser) {
                showToast('Please login to update tasks', 'error');
                return false;
            }

            try {
                const db = window.firebaseDb;
                const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                const taskRef = doc(db, "todos", taskId);
                await updateDoc(taskRef, {
                    ...updates,
                    updatedAt: serverTimestamp()
                });

                console.log("Task updated:", taskId);
                return true;
            } catch (error) {
                console.error("Error updating task:", error);
                showToast('Failed to update task', 'error');
                return false;
            }
        }

        // Delete a task for the current user
        async function deleteTaskForCurrentUser(taskId) {
            if (!currentUser) {
                showToast('Please login to delete tasks', 'error');
                return false;
            }

            try {
                const db = window.firebaseDb;
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                const taskRef = doc(db, "todos", taskId);
                await deleteDoc(taskRef);

                console.log("Task deleted:", taskId);
                return true;
            } catch (error) {
                console.error("Error deleting task:", error);
                showToast('Failed to delete task', 'error');
                return false;
            }
        }

        // Subscribe to tasks for the current user (real-time updates)
        function subscribeToTasksForCurrentUser(callback) {
            if (!currentUser) {
                console.log("No user logged in, cannot subscribe to tasks");
                return null;
            }

            // Unsubscribe from previous subscription if exists
            if (unsubscribeTasks) {
                unsubscribeTasks();
            }

            (async () => {
                try {
                    const db = window.firebaseDb;
                    const { collection, query, where, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                    const q = query(
                        collection(db, "todos"),
                        where("userId", "==", currentUser.uid)
                    );

                    unsubscribeTasks = onSnapshot(q, (snapshot) => {
                        tasks = [];
                        snapshot.forEach((doc) => {
                            tasks.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        console.log(`Loaded ${tasks.length} tasks from Firestore`);
                        callback(tasks);
                        updateStats();
                        updateStreakDisplay();
                    }, (error) => {
                        console.error("Error subscribing to tasks:", error);
                        showToast('Failed to load tasks', 'error');
                    });

                } catch (error) {
                    console.error("Error setting up task subscription:", error);
                    showToast('Failed to setup task sync', 'error');
                }
            })();
        }

        // OLD LOCAL STORAGE IMPLEMENTATION (no longer used for tasks)
        // function loadTasksFromStorage() {
        //     const stored = localStorage.getItem('todo_tasks');
        //     if (stored) {
        //         tasks = JSON.parse(stored);
        //         if (tasks.length > 0) {
        //             nextId = Math.max(...tasks.map(t => t.id)) + 1;
        //         }
        //     }
        // }

        // function saveTasksToStorage() {
        //     localStorage.setItem('todo_tasks', JSON.stringify(tasks));
        // }

        // Load streak data from localStorage
        function loadStreakData() {
            const stored = localStorage.getItem('todo_streak');
            if (stored) {
                streakData = JSON.parse(stored);
                checkStreakValidity();
            }
        }

        // Save streak data to localStorage
        function saveStreakData() {
            localStorage.setItem('todo_streak', JSON.stringify(streakData));
        }

        // Check if streak is still valid (reset if more than 1 day passed)
        function checkStreakValidity() {
            if (!streakData.lastCompletionDate) return;

            const today = new Date().toDateString();
            const lastDate = new Date(streakData.lastCompletionDate).toDateString();

            if (today !== lastDate) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                if (lastDate !== yesterdayStr) {
                    // Streak broken - more than 1 day passed
                    streakData.currentStreak = 0;
                }
                // Reset today's count
                streakData.todayCompletions = 0;
                saveStreakData();
            }
        }

        // Update streak when task is completed
        function updateStreak() {
            const today = new Date().toDateString();
            const lastDate = streakData.lastCompletionDate ? new Date(streakData.lastCompletionDate).toDateString() : null;

            if (today !== lastDate) {
                // First completion today
                streakData.currentStreak += 1;
                streakData.lastCompletionDate = new Date().toISOString();
                streakData.todayCompletions = 1;
            } else {
                // Additional completion today
                streakData.todayCompletions += 1;
            }

            saveStreakData();
            updateStreakDisplay();
        }

        // Update streak display in header
        function updateStreakDisplay() {
            const streakDisplay = document.getElementById('streakDisplay');
            const todayDisplay = document.getElementById('todayTasksDisplay');

            const streakText = streakData.currentStreak === 1 ? 'day' : 'days';
            streakDisplay.textContent = `üî• ${streakData.currentStreak} ${streakText} streak`;

            const taskText = streakData.todayCompletions === 1 ? 'task' : 'tasks';
            todayDisplay.textContent = `${streakData.todayCompletions} ${taskText} completed today`;
        }

        // Render tasks to the board
        function renderTasks() {
            // Clear all columns
            document.getElementById('todoColumn').innerHTML = '';
            document.getElementById('inProgressColumn').innerHTML = '';
            document.getElementById('doneColumn').innerHTML = '';

            // Update tag filter dropdown
            updateTagFilter();

            // Apply filters
            const filteredTasks = filterTasks(tasks);

            // Filter and render tasks by status
            const todoTasks = filteredTasks.filter(t => t.status === 'todo');
            const inProgressTasks = filteredTasks.filter(t => t.status === 'in_progress');
            const doneTasks = filteredTasks.filter(t => t.status === 'done');

            // Render tasks or empty state
            if (todoTasks.length === 0) {
                renderEmptyState('todoColumn');
            } else {
                todoTasks.forEach(task => renderTask(task, 'todoColumn'));
            }

            if (inProgressTasks.length === 0) {
                renderEmptyState('inProgressColumn');
            } else {
                inProgressTasks.forEach(task => renderTask(task, 'inProgressColumn'));
            }

            if (doneTasks.length === 0) {
                renderEmptyState('doneColumn');
            } else {
                doneTasks.forEach(task => renderTask(task, 'doneColumn'));
            }

            // Update counters
            document.getElementById('todoCount').textContent = todoTasks.length;
            document.getElementById('inProgressCount').textContent = inProgressTasks.length;
            document.getElementById('doneCount').textContent = doneTasks.length;
        }

        // Render empty state for a column
        function renderEmptyState(columnId) {
            const column = document.getElementById(columnId);
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state text-center py-12 px-4 opacity-60';

            // Different messages for each column
            let icon, message, subtitle;
            if (columnId === 'todoColumn') {
                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>';
                message = 'No tasks yet';
                subtitle = 'Add your first task using the form ‚Üê';
            } else if (columnId === 'inProgressColumn') {
                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>';
                message = 'Nothing in progress';
                subtitle = 'Start working on a task!';
            } else {
                icon = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                message = 'No completed tasks';
                subtitle = 'Completed tasks will appear here!';
            }

            emptyState.innerHTML = `
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${icon}
                </svg>
                <p class="text-gray-400 font-medium">${message}</p>
                <p class="text-xs text-gray-300 mt-2">${subtitle}</p>
            `;
            column.appendChild(emptyState);
        }

        // Render a single task card
        function renderTask(task, columnId) {
            const column = document.getElementById(columnId);
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white border-2 border-gray-100 rounded-xl p-5 cursor-move hover:shadow-xl hover:border-blue-200 hover:-translate-y-1 transition-all duration-200';
            taskCard.setAttribute('data-task-id', task.id);
            taskCard.setAttribute('draggable', 'true');

            // Add drag event listeners
            taskCard.addEventListener('dragstart', handleDragStart);
            taskCard.addEventListener('dragend', handleDragEnd);

            taskCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 cursor-pointer hover:text-blue-600 mb-1" onclick="openEditModal('${task.id}')">${escapeHtml(task.title)}</h4>
                        <div class="flex gap-2 flex-wrap">
                            ${getPriorityBadge(task.priority || 'medium')}
                            ${getDueDateBadge(task.due_date, task.status)}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditModal('${task.id}')" class="text-blue-500 hover:text-blue-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="deleteTask('${task.id}')" class="text-red-500 hover:text-red-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
                ${task.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(task.description)}</p>` : ''}
                ${task.tags && task.tags.length > 0 ? `
                    <div class="tags-container mb-3">
                        ${task.tags.map(tag => getTagBadge(tag)).join('')}
                    </div>
                ` : ''}
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">${formatDate(task.created_at)}</span>
                    <div class="flex gap-2">
                        ${task.status !== 'todo' ? `
                            <button onclick="moveTask('${task.id}', 'todo')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded transition-colors">
                                ‚Üê To Do
                            </button>
                        ` : ''}
                        ${task.status === 'todo' ? `
                            <button onclick="moveTask('${task.id}', 'in_progress')" class="text-xs px-2 py-1 bg-blue-500 text-white hover:bg-blue-600 rounded transition-colors">
                                Start ‚Üí
                            </button>
                        ` : ''}
                        ${task.status === 'in_progress' ? `
                            <button onclick="moveTask('${task.id}', 'done')" class="text-xs px-2 py-1 bg-green-500 text-white hover:bg-green-600 rounded transition-colors">
                                Complete ‚Üí
                            </button>
                        ` : ''}
                        ${task.status === 'done' ? `
                            <button onclick="moveTask('${task.id}', 'in_progress')" class="text-xs px-2 py-1 bg-blue-200 hover:bg-blue-300 rounded transition-colors">
                                ‚Üê Resume
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            column.appendChild(taskCard);
        }

        // Handle add task form submission
        async function handleAddTask(e) {
            e.preventDefault();

            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const dueTime = document.getElementById('taskDueTime').value;
            const tagsInput = document.getElementById('taskTags').value.trim();

            if (!title) {
                showToast('Please enter a task title', 'error');
                return;
            }

            // Parse tags
            let tags = [];
            if (tagsInput) {
                tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
            }

            let dueDateTime = null;
            if (dueDate) {
                if (dueTime) {
                    dueDateTime = new Date(`${dueDate}T${dueTime}`).toISOString();
                } else {
                    dueDateTime = new Date(`${dueDate}T23:59`).toISOString();
                }
            }

            const taskData = {
                title,
                description: description || null,
                priority: priority || 'medium',
                status: 'todo',
                due_date: dueDateTime,
                tags: tags,
                notified: false
            };

            const createdTask = await createTaskForCurrentUser(taskData);

            if (createdTask) {
                // Clear form
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskDueTime').value = '';
                document.getElementById('taskTags').value = '';

                // Clear validation states
                clearValidation('taskTitle');
                updateCharCounter('taskTitle', 0, 100);
                updateCharCounter('taskDescription', 0, 500);

                showToast('Task added successfully!', 'success');
            }
        }

        // Handle quick add form submission
        async function handleQuickAdd(e) {
            e.preventDefault();

            const title = document.getElementById('quickTaskTitle').value.trim();
            const priority = document.getElementById('quickTaskPriority').value;

            if (!title) {
                showToast('Please enter a task title', 'error');
                return;
            }

            const taskData = {
                title,
                description: null,
                priority: priority || 'medium',
                status: 'todo',
                due_date: null,
                notified: false
            };

            const createdTask = await createTaskForCurrentUser(taskData);

            if (createdTask) {
                // Clear form
                document.getElementById('quickTaskTitle').value = '';
                document.getElementById('quickTaskPriority').value = 'medium';

                showToast('‚ö° Task added quickly!', 'success');

                // Optional: Focus back on quick add input for rapid task entry
                document.getElementById('quickTaskTitle').focus();
            }
        }

        // Move task to different status
        async function moveTask(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const oldStatus = task.status;

            // Update in Firestore
            const success = await updateTaskForCurrentUser(taskId, { status: newStatus });

            if (success) {
                // Update streak when completing a task
                if (newStatus === 'done' && oldStatus !== 'done') {
                    updateStreak();
                    triggerConfetti();
                    showToast('Task completed! üéâ', 'success');
                } else {
                    showToast('Task moved successfully!', 'success');
                }
            }
        }

        // Trigger confetti animation
        function triggerConfetti() {
            const count = 200;
            const defaults = {
                origin: { y: 0.7 }
            };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, {
                spread: 26,
                startVelocity: 55,
            });

            fire(0.2, {
                spread: 60,
            });

            fire(0.35, {
                spread: 100,
                decay: 0.91,
                scalar: 0.8
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 25,
                decay: 0.92,
                scalar: 1.2
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 45,
            });
        }

        // Delete task
        let taskToDelete = null;

        function deleteTask(taskId) {
            // Store the task ID and show confirmation modal
            taskToDelete = taskId;
            const modal = document.getElementById('deleteConfirmModal');
            modal.classList.remove('hidden');
        }

        function closeDeleteConfirmModal() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.classList.add('hidden');
            taskToDelete = null;
        }

        // Confirm delete button handler
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (!taskToDelete) return;

            const success = await deleteTaskForCurrentUser(taskToDelete);

            if (success) {
                showToast('Task deleted successfully!', 'success');
            }

            closeDeleteConfirmModal();
        });

        // Edit Task functionality
        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = document.getElementById('editModal');
            const editTaskId = document.getElementById('editTaskId');
            const editTaskTitle = document.getElementById('editTaskTitle');
            const editTaskDescription = document.getElementById('editTaskDescription');
            const editTaskPriority = document.getElementById('editTaskPriority');
            const editTaskDueDate = document.getElementById('editTaskDueDate');
            const editTaskDueTime = document.getElementById('editTaskDueTime');

            editTaskId.value = task.id;
            editTaskTitle.value = task.title;
            editTaskDescription.value = task.description || '';
            editTaskPriority.value = task.priority || 'medium';

            if (task.due_date) {
                const dueDate = new Date(task.due_date);
                editTaskDueDate.value = dueDate.toISOString().split('T')[0];
                editTaskDueTime.value = dueDate.toTimeString().slice(0, 5);
            } else {
                editTaskDueDate.value = '';
                editTaskDueTime.value = '';
            }

            modal.classList.remove('hidden');
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
        }

        async function handleEditTask(e) {
            e.preventDefault();

            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value.trim();
            const description = document.getElementById('editTaskDescription').value.trim();
            const priority = document.getElementById('editTaskPriority').value;
            const dueDate = document.getElementById('editTaskDueDate').value;
            const dueTime = document.getElementById('editTaskDueTime').value;

            if (!title) {
                showToast('Please enter a task title', 'error');
                return;
            }

            let dueDateTime = null;
            if (dueDate) {
                if (dueTime) {
                    dueDateTime = new Date(`${dueDate}T${dueTime}`).toISOString();
                } else {
                    dueDateTime = new Date(`${dueDate}T23:59`).toISOString();
                }
            }

            const updates = {
                title,
                description: description || null,
                priority: priority || 'medium',
                due_date: dueDateTime,
                notified: false // Reset notification flag when due date changes
            };

            const success = await updateTaskForCurrentUser(taskId, updates);

            if (success) {
                closeEditModal();
                showToast('Task updated successfully!', 'success');
            }
        }

        // Drag and Drop functionality
        let draggedTaskId = null;

        function handleDragStart(e) {
            draggedTaskId = e.target.getAttribute('data-task-id');
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('column') || e.target.closest('.column')) {
                const column = e.target.classList.contains('column') ? e.target : e.target.closest('.column');
                column.classList.add('bg-blue-50');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('column') || e.target.closest('.column')) {
                const column = e.target.classList.contains('column') ? e.target : e.target.closest('.column');
                column.classList.remove('bg-blue-50');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const column = e.target.classList.contains('column') ? e.target : e.target.closest('.column');
            if (column) {
                column.classList.remove('bg-blue-50');

                const columnId = column.id;
                let newStatus;

                if (columnId === 'todoColumn') {
                    newStatus = 'todo';
                } else if (columnId === 'inProgressColumn') {
                    newStatus = 'in_progress';
                } else if (columnId === 'doneColumn') {
                    newStatus = 'done';
                }

                if (newStatus && draggedTaskId) {
                    moveTask(draggedTaskId, newStatus);
                }
            }

            return false;
        }

        // Setup drag and drop for columns
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.column');
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        // Utility: Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            if (type === 'error') {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }

            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Utility: Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Utility: Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Utility: Get priority badge HTML
        function getPriorityBadge(priority) {
            const badges = {
                low: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">üü¢ Low</span>',
                medium: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">üü° Medium</span>',
                high: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">üî¥ High</span>'
            };
            return badges[priority] || badges.medium;
        }

        // Get tag badge HTML
        function getTagBadge(tag) {
            const tagLower = tag.toLowerCase();
            let tagClass = 'tag-default';

            // Assign color based on tag name
            if (tagLower === 'work' || tagLower === 'business' || tagLower === 'project') {
                tagClass = 'tag-work';
            } else if (tagLower === 'personal' || tagLower === 'life' || tagLower === 'home') {
                tagClass = 'tag-personal';
            } else if (tagLower === 'urgent' || tagLower === 'important' || tagLower === 'critical') {
                tagClass = 'tag-urgent';
            } else if (tagLower === 'meeting' || tagLower === 'call' || tagLower === 'event') {
                tagClass = 'tag-meeting';
            }

            return `<span class="tag-badge ${tagClass}">${escapeHtml(tag)}</span>`;
        }

        // Badges/Achievements System
        function getAchievements() {
            const completedTasks = tasks.filter(t => t.status === 'done').length;
            const totalTasks = tasks.length;

            const achievements = [
                {
                    id: 'first_task',
                    name: 'Getting Started',
                    description: 'Complete your first task',
                    icon: 'üéØ',
                    unlocked: completedTasks >= 1,
                    progress: Math.min(completedTasks, 1),
                    target: 1
                },
                {
                    id: 'five_tasks',
                    name: 'Productivity Rookie',
                    description: 'Complete 5 tasks',
                    icon: '‚≠ê',
                    unlocked: completedTasks >= 5,
                    progress: Math.min(completedTasks, 5),
                    target: 5
                },
                {
                    id: 'ten_tasks',
                    name: 'Task Master',
                    description: 'Complete 10 tasks',
                    icon: 'üåü',
                    unlocked: completedTasks >= 10,
                    progress: Math.min(completedTasks, 10),
                    target: 10
                },
                {
                    id: 'twenty_five_tasks',
                    name: 'Productivity Pro',
                    description: 'Complete 25 tasks',
                    icon: 'üí´',
                    unlocked: completedTasks >= 25,
                    progress: Math.min(completedTasks, 25),
                    target: 25
                },
                {
                    id: 'fifty_tasks',
                    name: 'Task Legend',
                    description: 'Complete 50 tasks',
                    icon: 'üèÜ',
                    unlocked: completedTasks >= 50,
                    progress: Math.min(completedTasks, 50),
                    target: 50
                },
                {
                    id: 'three_day_streak',
                    name: 'Consistent',
                    description: 'Maintain a 3-day streak',
                    icon: 'üî•',
                    unlocked: streakData.currentStreak >= 3,
                    progress: Math.min(streakData.currentStreak, 3),
                    target: 3
                },
                {
                    id: 'seven_day_streak',
                    name: 'Week Warrior',
                    description: 'Maintain a 7-day streak',
                    icon: 'üí™',
                    unlocked: streakData.currentStreak >= 7,
                    progress: Math.min(streakData.currentStreak, 7),
                    target: 7
                },
                {
                    id: 'thirty_day_streak',
                    name: 'Month Master',
                    description: 'Maintain a 30-day streak',
                    icon: 'üëë',
                    unlocked: streakData.currentStreak >= 30,
                    progress: Math.min(streakData.currentStreak, 30),
                    target: 30
                },
                {
                    id: 'high_priority',
                    name: 'Priority Player',
                    description: 'Complete a high-priority task',
                    icon: 'üî¥',
                    unlocked: tasks.some(t => t.status === 'done' && t.priority === 'high'),
                    progress: tasks.some(t => t.status === 'done' && t.priority === 'high') ? 1 : 0,
                    target: 1
                },
                {
                    id: 'busy_day',
                    name: 'Busy Bee',
                    description: 'Complete 5 tasks in one day',
                    icon: 'üêù',
                    unlocked: streakData.todayCompletions >= 5,
                    progress: Math.min(streakData.todayCompletions, 5),
                    target: 5
                }
            ];

            return achievements;
        }

        function openBadgesModal() {
            const modal = document.getElementById('badgesModal');
            const content = document.getElementById('badgesContent');

            const achievements = getAchievements();
            const unlockedCount = achievements.filter(a => a.unlocked).length;

            content.innerHTML = achievements.map(achievement => `
                <div class="p-4 rounded-lg border-2 ${achievement.unlocked ? 'bg-gradient-to-br from-yellow-50 to-orange-50 border-yellow-300' : 'bg-gray-50 border-gray-200 opacity-60'}">
                    <div class="flex items-start gap-3">
                        <div class="text-4xl ${achievement.unlocked ? 'grayscale-0' : 'grayscale'}">${achievement.icon}</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg ${achievement.unlocked ? 'text-gray-900' : 'text-gray-500'}">${achievement.name}</h3>
                            <p class="text-sm text-gray-600 mb-2">${achievement.description}</p>
                            ${!achievement.unlocked ? `
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${(achievement.progress / achievement.target) * 100}%"></div>
                                </div>
                                <p class="text-xs text-gray-500">${achievement.progress} / ${achievement.target}</p>
                            ` : '<span class="text-xs font-semibold text-green-600">‚úì UNLOCKED</span>'}
                        </div>
                    </div>
                </div>
            `).join('');

            // Add summary at the top
            content.insertAdjacentHTML('afterbegin', `
                <div class="col-span-1 md:col-span-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg mb-2">
                    <h3 class="text-xl font-bold mb-2">Progress Summary</h3>
                    <p class="text-lg">${unlockedCount} / ${achievements.length} achievements unlocked</p>
                    <div class="w-full bg-white bg-opacity-30 rounded-full h-3 mt-2">
                        <div class="bg-white h-3 rounded-full transition-all duration-500" style="width: ${(unlockedCount / achievements.length) * 100}%"></div>
                    </div>
                </div>
            `);

            modal.classList.remove('hidden');
        }

        function closeBadgesModal() {
            const modal = document.getElementById('badgesModal');
            modal.classList.add('hidden');
        }

        // Theme System
        function loadTheme() {
            const savedTheme = localStorage.getItem('todo_theme') || 'default';
            setTheme(savedTheme, false);
        }

        function setTheme(theme, save = true) {
            const body = document.body;

            // Remove all theme classes
            body.classList.remove('dark-theme');

            // Add new theme class
            if (theme === 'dark') {
                body.classList.add('dark-theme');
            }
            // Default theme (no class) is the modern gradient background with glows

            // Update checkmarks
            document.getElementById('default-check')?.classList.add('hidden');
            document.getElementById('dark-check')?.classList.add('hidden');

            if (theme === 'dark') {
                document.getElementById('dark-check')?.classList.remove('hidden');
            } else {
                // Show default checkmark
                document.getElementById('default-check')?.classList.remove('hidden');
            }

            // Save to localStorage
            if (save) {
                localStorage.setItem('todo_theme', theme);
                showToast(`Theme changed to ${theme}!`, 'success');
                closeThemeModal();
            }
        }

        function openThemeModal() {
            const modal = document.getElementById('themeModal');
            modal.classList.remove('hidden');
        }

        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            modal.classList.add('hidden');
        }

        // Utility: Get due date badge HTML
        function getDueDateBadge(dueDate, status) {
            if (!dueDate || status === 'done') return '';

            const now = new Date();
            const due = new Date(dueDate);
            const diffMs = due - now;
            const diffHours = diffMs / (1000 * 60 * 60);

            let badgeClass = '';
            let icon = 'üìÖ';
            let text = '';

            if (diffMs < 0) {
                // Overdue
                badgeClass = 'bg-red-100 text-red-800 border border-red-300';
                icon = '‚ö†Ô∏è';
                const days = Math.ceil(Math.abs(diffMs) / (1000 * 60 * 60 * 24));
                text = days === 0 ? 'Overdue today' : `Overdue ${days}d`;
            } else if (diffHours < 24) {
                // Due today
                badgeClass = 'bg-orange-100 text-orange-800 border border-orange-300';
                icon = 'üîî';
                const hours = Math.ceil(diffHours);
                text = hours === 0 ? 'Due now' : `Due in ${hours}h`;
            } else if (diffHours < 48) {
                // Due tomorrow
                badgeClass = 'bg-yellow-100 text-yellow-800';
                icon = '‚è∞';
                text = 'Due tomorrow';
            } else {
                // Future
                badgeClass = 'bg-blue-100 text-blue-800';
                const days = Math.ceil(diffHours / 24);
                text = `Due in ${days}d`;
            }

            const dateStr = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${badgeClass}" title="${dateStr}">${icon} ${text}</span>`;
        }

        // Notification System
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Notifications enabled! You\'ll be alerted when tasks are due.', 'success');
                    }
                });
            }
        }

        function checkDueTasksAndNotify() {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }

            const now = new Date();

            tasks.forEach(task => {
                if (!task.due_date || task.status === 'done' || task.notified) {
                    return;
                }

                const dueDate = new Date(task.due_date);
                const timeDiff = dueDate - now;

                // Notify if task is due within 15 minutes or overdue
                if (timeDiff <= 15 * 60 * 1000 && timeDiff >= -60 * 60 * 1000) {
                    const notification = new Notification('Task Due: ' + task.title, {
                        body: task.description || 'This task is due soon!',
                        icon: 'üìã',
                        tag: `task-${task.id}`,
                        requireInteraction: true
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    // Mark as notified
                    const index = tasks.findIndex(t => t.id === task.id);
                    if (index !== -1) {
                        tasks[index].notified = true;
                        saveTasksToStorage();
                    }
                }
            });
        }

        function startNotificationChecker() {
            // Check every minute
            setInterval(checkDueTasksAndNotify, 60 * 1000);
            // Also check immediately
            setTimeout(checkDueTasksAndNotify, 3000);
        }

        // Stats System
        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'done').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statRate').textContent = rate + '%';
        }

        // Filter System
        function setupFilterListeners() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filters.search = e.target.value.toLowerCase();
                renderTasks();
            });

            document.getElementById('filterPriority').addEventListener('change', (e) => {
                filters.priority = e.target.value;
                renderTasks();
            });

            document.getElementById('filterStatus').addEventListener('change', (e) => {
                filters.status = e.target.value;
                renderTasks();
            });

            document.getElementById('filterQuick').addEventListener('change', (e) => {
                filters.quick = e.target.value;
                renderTasks();
            });

            document.getElementById('filterTag').addEventListener('change', (e) => {
                filters.tag = e.target.value;
                renderTasks();
            });
        }

        function filterTasks(taskList) {
            return taskList.filter(task => {
                // Search filter
                if (filters.search && !task.title.toLowerCase().includes(filters.search)) {
                    return false;
                }

                // Priority filter
                if (filters.priority !== 'all' && task.priority !== filters.priority) {
                    return false;
                }

                // Status filter
                if (filters.status !== 'all' && task.status !== filters.status) {
                    return false;
                }

                // Quick filters
                if (filters.quick !== 'all') {
                    if (filters.quick === 'today') {
                        if (!task.due_date) return false;
                        const due = new Date(task.due_date);
                        const today = new Date();
                        if (due.toDateString() !== today.toDateString()) return false;
                    } else if (filters.quick === 'overdue') {
                        if (!task.due_date || task.status === 'done') return false;
                        const due = new Date(task.due_date);
                        if (due > new Date()) return false;
                    } else if (filters.quick === 'upcoming') {
                        if (!task.due_date || task.status === 'done') return false;
                        const due = new Date(task.due_date);
                        const now = new Date();
                        const diffDays = (due - now) / (1000 * 60 * 60 * 24);
                        if (diffDays < 0 || diffDays > 7) return false;
                    }
                }

                // Tag filter
                if (filters.tag && filters.tag !== 'all') {
                    if (!task.tags || !Array.isArray(task.tags)) return false;
                    if (!task.tags.some(tag => tag.toLowerCase() === filters.tag.toLowerCase())) {
                        return false;
                    }
                }

                return true;
            });
        }

        function clearFilters() {
            filters = {
                search: '',
                priority: 'all',
                status: 'all',
                quick: 'all',
                tag: 'all'
            };

            document.getElementById('searchInput').value = '';
            document.getElementById('filterPriority').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterQuick').value = 'all';
            document.getElementById('filterTag').value = 'all';

            renderTasks();
        }

        // Update tag filter dropdown with available tags
        function updateTagFilter() {
            const tagFilter = document.getElementById('filterTag');
            const currentValue = tagFilter.value;

            // Collect all unique tags from tasks
            const allTags = new Set();
            tasks.forEach(task => {
                if (task.tags && Array.isArray(task.tags)) {
                    task.tags.forEach(tag => allTags.add(tag));
                }
            });

            // Clear and rebuild options
            tagFilter.innerHTML = '<option value="all">All Tags</option>';

            // Sort tags alphabetically and add to dropdown
            Array.from(allTags)
                .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()))
                .forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    tagFilter.appendChild(option);
                });

            // Restore previous selection if still available
            if (currentValue && currentValue !== 'all') {
                const optionExists = Array.from(tagFilter.options).some(opt => opt.value === currentValue);
                if (optionExists) {
                    tagFilter.value = currentValue;
                } else {
                    tagFilter.value = 'all';
                    filters.tag = 'all';
                }
            }
        }

        // Export/Import functionality removed - tasks are now stored in Firebase Firestore

        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', function(e) {
            // ESC - Close any open modal
            if (e.key === 'Escape') {
                closeEditModal();
                closeThemeModal();
                closeBadgesModal();
                closeDeleteConfirmModal();
                return;
            }

            // Don't trigger shortcuts if user is typing in an input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                // Ctrl/Cmd + Enter in task forms to submit
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    if (e.target.closest('#addTaskForm')) {
                        document.getElementById('addTaskForm').dispatchEvent(new Event('submit'));
                    } else if (e.target.closest('#editTaskForm')) {
                        document.getElementById('editTaskForm').dispatchEvent(new Event('submit'));
                    }
                }
                return;
            }

            // N - Focus on quick add input (new task)
            if (e.key === 'n' || e.key === 'N') {
                e.preventDefault();
                const quickAddInput = document.getElementById('quickTaskTitle');
                if (quickAddInput) {
                    quickAddInput.focus();
                    // Scroll to quick add bar
                    quickAddInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            // / - Focus on search input
            if (e.key === '/') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
                return;
            }
        });

        // Auto-focus on task title when page loads (after login)
        window.addEventListener('load', function() {
            // Small delay to ensure elements are rendered
            setTimeout(() => {
                const taskTitle = document.getElementById('taskTitle');
                if (taskTitle && document.getElementById('app-container').style.display !== 'none') {
                    taskTitle.focus();
                }
            }, 500);
        });
    </script>

    <!-- Account Menu (only visible when logged in) -->
    <header class="account-header" id="accountHeader" style="display:none;">
        <button class="account-chip" id="accountChip">
            <span class="account-name" id="accountName">My Account</span>
            <span class="account-arrow">‚ñæ</span>
        </button>

        <div class="account-menu" id="accountMenu">
            <button class="account-menu-item" id="profileBtn">Profile</button>
            <button class="account-menu-item" id="themeBtn">Theme</button>
            <button class="account-menu-item" id="changePasswordBtn">Change password</button>
            <button class="account-menu-item" id="logoutBtnMenu">Logout</button>
        </div>
    </header>

    <!-- Profile Modal -->
    <div class="modal-backdrop" id="profileModal">
        <div class="modal">
            <h2>Profile Settings</h2>
            <div id="profile-error" class="mb-3 hidden" style="color: #f87171; font-size: 0.85rem;"></div>
            <div id="profile-success" class="mb-3 hidden" style="color: #4ade80; font-size: 0.85rem;"></div>

            <label>
                <span>Username</span>
                <input type="text" id="profileUsername" placeholder="Enter your username" maxlength="30">
            </label>

            <label>
                <span>Email</span>
                <input type="email" id="profileEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
            </label>

            <label>
                <span>Display Name (Optional)</span>
                <input type="text" id="profileDisplayName" placeholder="Your full name" maxlength="50">
            </label>

            <div class="modal-actions">
                <button id="cancelProfile">Cancel</button>
                <button class="primary" id="saveProfile">Save</button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal-backdrop" id="passwordModal">
        <div class="modal">
            <h2>Change password</h2>
            <div id="password-error" class="mb-3 hidden" style="color: #f87171; font-size: 0.85rem;"></div>
            <div id="password-success" class="mb-3 hidden" style="color: #4ade80; font-size: 0.85rem;"></div>
            <label>
                <span>Current password</span>
                <input type="password" id="currentPassword">
            </label>
            <label>
                <span>New password</span>
                <input type="password" id="newPassword">
            </label>
            <label>
                <span>Confirm new password</span>
                <input type="password" id="confirmPassword">
            </label>
            <div class="modal-actions">
                <button id="cancelPassword">Cancel</button>
                <button class="primary" id="savePassword">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Account menu functionality
        const accountHeader = document.getElementById('accountHeader');
        const chip = document.getElementById('accountChip');
        const menu = document.getElementById('accountMenu');
        const accountName = document.getElementById('accountName');
        const passwordModal = document.getElementById('passwordModal');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const cancelPassword = document.getElementById('cancelPassword');
        const savePassword = document.getElementById('savePassword');
        const logoutBtnMenu = document.getElementById('logoutBtnMenu');
        const profileBtn = document.getElementById('profileBtn');
        const themeBtn = document.getElementById('themeBtn');

        chip.addEventListener('click', (e) => {
            e.stopPropagation();
            menu.classList.toggle('open');
        });

        document.addEventListener('click', () => {
            menu.classList.remove('open');
        });

        themeBtn.addEventListener('click', () => {
            menu.classList.remove('open');
            openThemeModal();
        });

        changePasswordBtn.addEventListener('click', () => {
            menu.classList.remove('open');
            passwordModal.classList.add('open');
            // Clear form
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('password-error').classList.add('hidden');
            document.getElementById('password-success').classList.add('hidden');
        });

        cancelPassword.addEventListener('click', () => {
            passwordModal.classList.remove('open');
        });

        // Change password functionality
        savePassword.addEventListener('click', async () => {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('password-error');
            const successDiv = document.getElementById('password-success');

            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const auth = window.firebaseAuth;
                const user = auth.currentUser;

                // Re-authenticate user with current password
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    currentPassword
                );

                await user.reauthenticateWithCredential(credential);

                // Update password
                await user.updatePassword(newPassword);

                successDiv.textContent = 'Password changed successfully!';
                successDiv.classList.remove('hidden');

                // Close modal after 1.5 seconds
                setTimeout(() => {
                    passwordModal.classList.remove('open');
                }, 1500);

            } catch (error) {
                console.error('Error changing password:', error);
                if (error.code === 'auth/wrong-password') {
                    errorDiv.textContent = 'Current password is incorrect';
                } else if (error.code === 'auth/weak-password') {
                    errorDiv.textContent = 'Password is too weak';
                } else {
                    errorDiv.textContent = 'Error changing password: ' + error.message;
                }
                errorDiv.classList.remove('hidden');
            }
        });

        // Logout from menu
        logoutBtnMenu.addEventListener('click', () => {
            menu.classList.remove('open');
            window.firebaseAuth.signOut();
        });

        // Profile functionality
        const profileModal = document.getElementById('profileModal');
        const cancelProfile = document.getElementById('cancelProfile');
        const saveProfile = document.getElementById('saveProfile');

        profileBtn.addEventListener('click', async () => {
            menu.classList.remove('open');
            profileModal.classList.add('open');

            // Load current profile data
            await loadUserProfile();

            // Clear messages
            document.getElementById('profile-error').classList.add('hidden');
            document.getElementById('profile-success').classList.add('hidden');
        });

        cancelProfile.addEventListener('click', () => {
            profileModal.classList.remove('open');
        });

        saveProfile.addEventListener('click', async () => {
            const username = document.getElementById('profileUsername').value.trim();
            const displayName = document.getElementById('profileDisplayName').value.trim();
            const errorDiv = document.getElementById('profile-error');
            const successDiv = document.getElementById('profile-success');

            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // Validation
            if (!username) {
                errorDiv.textContent = 'Username is required';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (username.length < 3) {
                errorDiv.textContent = 'Username must be at least 3 characters';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Check if username contains only valid characters (alphanumeric, underscore, hyphen)
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                errorDiv.textContent = 'Username can only contain letters, numbers, underscore, and hyphen';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const auth = window.firebaseAuth;
                const db = window.firebaseDb;
                const { doc, setDoc, serverTimestamp } = window.firebaseFunctions;
                const user = auth.currentUser;

                // Save user profile to Firestore
                const userDocRef = doc(db, 'users', user.uid);
                await setDoc(userDocRef, {
                    username: username,
                    displayName: displayName,
                    email: user.email,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                // Update account name display
                accountName.textContent = username;

                successDiv.textContent = 'Profile updated successfully!';
                successDiv.classList.remove('hidden');

                // Close modal after 1.5 seconds
                setTimeout(() => {
                    profileModal.classList.remove('open');
                }, 1500);

            } catch (error) {
                console.error('Error updating profile:', error);
                errorDiv.textContent = 'Error updating profile: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });
    </script>

</body>
</html>
