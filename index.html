<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO App - Task Manager (Standalone)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        .task-card {
            transition: all 0.3s ease;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .column {
            min-height: 400px;
            transition: background-color 0.2s ease;
        }
        .column.bg-blue-50 {
            background-color: rgba(239, 246, 255, 0.6);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .column {
                min-height: 200px;
            }

            /* Stack columns vertically on mobile */
            .kanban-board {
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            /* Make header more compact */
            header h1 {
                font-size: 1.5rem !important;
            }

            header p {
                font-size: 0.75rem !important;
            }

            /* Hide some text on very small screens */
            .hide-mobile-text {
                display: none;
            }

            /* Make buttons more touch-friendly */
            button {
                min-height: 44px;
            }

            /* Adjust stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Single column for filters on mobile */
            .filters-grid {
                grid-template-columns: 1fr !important;
            }

            /* Make modals full screen on mobile */
            .modal-content {
                width: 100vw !important;
                height: 100vh !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }
        }

        /* Dark Theme */
        body.dark-theme {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        body.dark-theme header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }
        body.dark-theme .bg-white {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        body.dark-theme .text-gray-700 {
            color: #cbd5e0;
        }
        body.dark-theme .text-gray-800 {
            color: #e2e8f0;
        }
        body.dark-theme .text-gray-600 {
            color: #a0aec0;
        }
        body.dark-theme .text-gray-500 {
            color: #718096;
        }
        body.dark-theme .bg-gray-50 {
            background-color: #374151;
        }
        body.dark-theme .border-gray-200,
        body.dark-theme .border-gray-300 {
            border-color: #4a5568;
        }
        body.dark-theme input,
        body.dark-theme textarea,
        body.dark-theme select {
            background-color: #374151;
            color: #e2e8f0;
            border-color: #4a5568;
        }

        /* Minimal Theme */
        body.minimal-theme {
            background-color: #fafafa;
        }
        body.minimal-theme header {
            background: white;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }
        body.minimal-theme .bg-blue-600 {
            background-color: #333;
        }
        body.minimal-theme .text-blue-100 {
            color: #666;
        }
        body.minimal-theme .bg-white {
            background-color: white;
            border: 1px solid #e0e0e0;
        }
        body.minimal-theme .bg-gray-50 {
            background-color: #fafafa;
        }
        body.minimal-theme .task-card {
            border: 1px solid #e0e0e0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 md:py-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-0">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold">üìã Task Manager</h1>
                    <p class="text-blue-100 mt-1 text-sm md:text-base">Organize your tasks efficiently</p>
                </div>
                <div class="w-full md:w-auto flex flex-wrap items-center gap-2 md:gap-4">
                    <button onclick="openThemeModal()" class="bg-purple-500 hover:bg-purple-700 px-3 md:px-4 py-2 rounded-lg transition-colors text-sm md:text-base">
                        üé®<span class="hidden sm:inline"> Theme</span>
                    </button>
                    <button onclick="openBadgesModal()" class="bg-blue-500 hover:bg-blue-700 px-3 md:px-4 py-2 rounded-lg transition-colors text-sm md:text-base">
                        üèÜ<span class="hidden sm:inline"> Achievements</span>
                    </button>
                    <div class="flex-1 md:flex-none text-left md:text-right">
                        <div id="streakDisplay" class="text-lg md:text-2xl font-bold">üî• 0 day streak</div>
                        <div id="todayTasksDisplay" class="text-xs md:text-sm text-blue-100 mt-1">0 tasks completed today</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Authentication Section -->
        <section id="auth-section" class="mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Account</h2>

                <!-- Login/Register Forms (shown when not logged in) -->
                <div id="auth-forms">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Login Form -->
                        <div id="login-form" class="border-r md:pr-6">
                            <h3 class="text-lg font-medium mb-3">Login</h3>
                            <form id="loginForm" class="space-y-3">
                                <input
                                    id="login-email"
                                    type="email"
                                    placeholder="Email"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <input
                                    id="login-password"
                                    type="password"
                                    placeholder="Password"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button
                                    id="login-btn"
                                    type="submit"
                                    class="w-full bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    Login
                                </button>
                            </form>
                        </div>

                        <!-- Register Form -->
                        <div id="register-form">
                            <h3 class="text-lg font-medium mb-3">Create Account</h3>
                            <form id="registerForm" class="space-y-3">
                                <input
                                    id="register-email"
                                    type="email"
                                    placeholder="Email"
                                    required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <input
                                    id="register-password"
                                    type="password"
                                    placeholder="Password (min 6 characters)"
                                    required
                                    minlength="6"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button
                                    id="register-btn"
                                    type="submit"
                                    class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">
                                    Register
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- User Info (shown when logged in) -->
                <div id="auth-user-info" style="display:none;">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Logged in as:</p>
                            <p id="user-email" class="font-semibold text-lg"></p>
                        </div>
                        <button
                            id="logout-btn"
                            class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            Logout
                        </button>
                    </div>
                </div>

                <!-- Auth Error Message -->
                <p id="auth-error" class="mt-3 text-red-600 text-sm hidden"></p>
            </div>
        </section>

        <!-- App Container (hidden until logged in) -->
        <div id="app-container" style="display:none;">
        <!-- Stats Dashboard -->
        <div class="stats-grid grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6 md:mb-8">
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">Total Tasks</p>
                        <p id="statTotal" class="text-2xl md:text-3xl font-bold text-gray-800">0</p>
                    </div>
                    <div class="text-3xl md:text-4xl">üìù</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">Completed</p>
                        <p id="statCompleted" class="text-2xl md:text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="text-3xl md:text-4xl">‚úÖ</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">In Progress</p>
                        <p id="statInProgress" class="text-2xl md:text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="text-3xl md:text-4xl">‚ö°</div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs md:text-sm text-gray-600">Completion Rate</p>
                        <p id="statRate" class="text-2xl md:text-3xl font-bold text-purple-600">0%</p>
                    </div>
                    <div class="text-3xl md:text-4xl">üìà</div>
                </div>
            </div>
        </div>

        <!-- Filters & Search -->
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6 md:mb-8">
            <div class="filters-grid grid grid-cols-1 md:grid-cols-4 gap-3 md:gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Tasks</label>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search by title..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Priority</label>
                    <select
                        id="filterPriority"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Priorities</option>
                        <option value="high">üî¥ High Only</option>
                        <option value="medium">üü° Medium Only</option>
                        <option value="low">üü¢ Low Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                    <select
                        id="filterStatus"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Statuses</option>
                        <option value="todo">To Do Only</option>
                        <option value="in_progress">In Progress Only</option>
                        <option value="done">Done Only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Filters</label>
                    <select
                        id="filterQuick"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="all">All Tasks</option>
                        <option value="today">üìÖ Due Today</option>
                        <option value="overdue">‚ö†Ô∏è Overdue</option>
                        <option value="upcoming">üîî Upcoming</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row gap-2">
                <button onclick="clearFilters()" class="w-full sm:w-auto px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors text-sm font-medium">
                    Clear Filters
                </button>
            </div>
        </div>

        <!-- Add Task Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Add New Task</h2>
            <form id="addTaskForm" class="space-y-4">
                <div>
                    <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                    <input
                        type="text"
                        id="taskTitle"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter task title...">
                </div>
                <div>
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                    <textarea
                        id="taskDescription"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter task description..."></textarea>
                </div>
                <div>
                    <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select
                        id="taskPriority"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="low">üü¢ Low Priority</option>
                        <option value="medium" selected>üü° Medium Priority</option>
                        <option value="high">üî¥ High Priority</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-1">Due Date (Optional)</label>
                        <input
                            type="date"
                            id="taskDueDate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="taskDueTime" class="block text-sm font-medium text-gray-700 mb-1">Due Time (Optional)</label>
                        <input
                            type="time"
                            id="taskDueTime"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <button
                    type="submit"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    Add Task
                </button>
            </form>
        </div>

        <!-- Task Board -->
        <div class="kanban-board grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
            <!-- TODO Column -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                    <h3 class="text-lg font-semibold text-gray-700">To Do</h3>
                    <span id="todoCount" class="ml-auto bg-gray-200 text-gray-700 px-2 py-1 rounded-full text-sm">0</span>
                </div>
                <div id="todoColumn" class="column space-y-3">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>

            <!-- IN PROGRESS Column -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                    <h3 class="text-lg font-semibold text-gray-700">In Progress</h3>
                    <span id="inProgressCount" class="ml-auto bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-sm">0</span>
                </div>
                <div id="inProgressColumn" class="column space-y-3">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>

            <!-- DONE Column -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-4">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <h3 class="text-lg font-semibold text-gray-700">Done</h3>
                    <span id="doneCount" class="ml-auto bg-green-100 text-green-700 px-2 py-1 rounded-full text-sm">0</span>
                </div>
                <div id="doneColumn" class="column space-y-3">
                    <!-- Tasks will be dynamically added here -->
                </div>
            </div>
        </div>
        </div><!-- End of app-container -->
    </main>

    <!-- Edit Task Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Edit Task</h2>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="editTaskForm" class="space-y-4">
                <input type="hidden" id="editTaskId">
                <div>
                    <label for="editTaskTitle" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                    <input
                        type="text"
                        id="editTaskTitle"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter task title...">
                </div>
                <div>
                    <label for="editTaskDescription" class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                    <textarea
                        id="editTaskDescription"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter task description..."></textarea>
                </div>
                <div>
                    <label for="editTaskPriority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                    <select
                        id="editTaskPriority"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="low">üü¢ Low Priority</option>
                        <option value="medium">üü° Medium Priority</option>
                        <option value="high">üî¥ High Priority</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="editTaskDueDate" class="block text-sm font-medium text-gray-700 mb-1">Due Date (Optional)</label>
                        <input
                            type="date"
                            id="editTaskDueDate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label for="editTaskDueTime" class="block text-sm font-medium text-gray-700 mb-1">Due Time (Optional)</label>
                        <input
                            type="time"
                            id="editTaskDueTime"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button
                        type="submit"
                        class="flex-1 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        Save Changes
                    </button>
                    <button
                        type="button"
                        onclick="closeEditModal()"
                        class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Theme Selector Modal -->
    <div id="themeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üé® Choose Theme</h2>
                <button onclick="closeThemeModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-3">
                <button onclick="setTheme('light')" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-blue-500 transition-all flex items-center gap-3">
                    <div class="text-2xl">‚òÄÔ∏è</div>
                    <div class="text-left flex-1">
                        <h3 class="font-bold">Light Theme</h3>
                        <p class="text-sm text-gray-600">Classic bright appearance</p>
                    </div>
                    <div id="light-check" class="hidden text-green-500">‚úì</div>
                </button>
                <button onclick="setTheme('dark')" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-blue-500 transition-all flex items-center gap-3">
                    <div class="text-2xl">üåô</div>
                    <div class="text-left flex-1">
                        <h3 class="font-bold">Dark Theme</h3>
                        <p class="text-sm text-gray-600">Easy on the eyes</p>
                    </div>
                    <div id="dark-check" class="hidden text-green-500">‚úì</div>
                </button>
                <button onclick="setTheme('minimal')" class="w-full p-4 rounded-lg border-2 border-gray-300 hover:border-blue-500 transition-all flex items-center gap-3">
                    <div class="text-2xl">‚ö™</div>
                    <div class="text-left flex-1">
                        <h3 class="font-bold">Minimal Theme</h3>
                        <p class="text-sm text-gray-600">Clean and simple</p>
                    </div>
                    <div id="minimal-check" class="hidden text-green-500">‚úì</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Badges/Achievements Modal -->
    <div id="badgesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">üèÜ Your Achievements</h2>
                <button onclick="closeBadgesModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="badgesContent" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Badges will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-all">
        <p id="toastMessage">Success!</p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase SDKs from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            deleteDoc,
            updateDoc,
            onSnapshot,
            query,
            where,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

        // Firebase web app configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSmStArK27afXhD73uJ2FuEkmOPe-pEqc",
            authDomain: "todo-app-47601.firebaseapp.com",
            projectId: "todo-app-47601",
            storageBucket: "todo-app-47601.firebasestorage.app",
            messagingSenderId: "756457875678",
            appId: "1:756457875678:web:fbd8155a9d91e211f57a4f",
            measurementId: "G-5JDJFZHNPL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose Firebase instances globally for other scripts
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseCore = { auth, db };

        console.log("Firebase initialized successfully");
    </script>

    <script>
        // Firebase-based Task Manager

        // State
        let tasks = [];
        let nextId = 1;
        let streakData = {
            currentStreak: 0,
            lastCompletionDate: null,
            todayCompletions: 0
        };

        // Filter state
        let filters = {
            search: '',
            priority: 'all',
            status: 'all',
            quick: 'all'
        };

        // Current user
        let currentUser = null;

        // Firestore unsubscribe function
        let unsubscribeTasks = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for Firebase to be available
            const initApp = setInterval(() => {
                if (window.firebaseAuth && window.firebaseDb) {
                    clearInterval(initApp);

                    loadStreakData();
                    loadTheme();
                    requestNotificationPermission();
                    setupEventListeners();
                    setupDragAndDrop();
                    setupFilterListeners();
                    startNotificationChecker();

                    // Setup authentication listener
                    setupAuthListener();
                }
            }, 100);
        });

        // Setup event listeners
        function setupEventListeners() {
            const form = document.getElementById('addTaskForm');
            form.addEventListener('submit', handleAddTask);

            const editForm = document.getElementById('editTaskForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEditTask);
            }

            // Auth event listeners
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }

            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        // Setup authentication state listener
        function setupAuthListener() {
            const auth = window.firebaseAuth;
            const { onAuthStateChanged } = window.firebaseCore;

            // This is a workaround since we can't directly import the function
            // We'll use the auth object's onAuthStateChanged method
            auth.onAuthStateChanged((user) => {
                currentUser = user;

                if (user) {
                    // User is logged in
                    console.log("User logged in:", user.email);

                    // Hide login/register forms
                    document.getElementById('auth-forms').style.display = 'none';

                    // Show user info and logout button
                    const userInfo = document.getElementById('auth-user-info');
                    userInfo.style.display = 'block';
                    document.getElementById('user-email').textContent = user.email;

                    // Show the main app
                    document.getElementById('app-container').style.display = 'block';

                    // Subscribe to user's tasks
                    subscribeToTasksForCurrentUser(renderTasks);

                    // Hide auth error
                    document.getElementById('auth-error').classList.add('hidden');
                } else {
                    // User is logged out
                    console.log("User logged out");

                    // Show login/register forms
                    document.getElementById('auth-forms').style.display = 'block';

                    // Hide user info
                    document.getElementById('auth-user-info').style.display = 'none';

                    // Hide the main app
                    document.getElementById('app-container').style.display = 'none';

                    // Clear tasks
                    tasks = [];

                    // Unsubscribe from tasks if subscribed
                    if (unsubscribeTasks) {
                        unsubscribeTasks();
                        unsubscribeTasks = null;
                    }
                }
            });
        }

        // Handle user registration
        async function handleRegister(e) {
            e.preventDefault();

            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;

            const authError = document.getElementById('auth-error');

            try {
                const auth = window.firebaseAuth;
                // Import createUserWithEmailAndPassword dynamically
                const { createUserWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("User registered:", userCredential.user.email);

                // Clear form
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';

                showToast('Account created successfully!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                authError.textContent = getAuthErrorMessage(error.code);
                authError.classList.remove('hidden');
            }
        }

        // Handle user login
        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            const authError = document.getElementById('auth-error');

            try {
                const auth = window.firebaseAuth;
                // Import signInWithEmailAndPassword dynamically
                const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("User logged in:", userCredential.user.email);

                // Clear form
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';

                showToast('Logged in successfully!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                authError.textContent = getAuthErrorMessage(error.code);
                authError.classList.remove('hidden');
            }
        }

        // Handle user logout
        async function handleLogout() {
            try {
                const auth = window.firebaseAuth;
                // Import signOut dynamically
                const { signOut } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js");

                await signOut(auth);
                console.log("User logged out");
                showToast('Logged out successfully!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Failed to logout', 'error');
            }
        }

        // Get user-friendly auth error messages
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': 'This email is already registered. Please login instead.',
                'auth/invalid-email': 'Invalid email address.',
                'auth/operation-not-allowed': 'Email/password accounts are not enabled.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Invalid email or password.',
                'auth/too-many-requests': 'Too many failed attempts. Please try again later.'
            };

            return errorMessages[errorCode] || 'An error occurred. Please try again.';
        }

        // ====================
        // STORAGE ABSTRACTION LAYER
        // ====================

        // Create a new task for the current user
        async function createTaskForCurrentUser(taskData) {
            if (!currentUser) {
                showToast('Please login to create tasks', 'error');
                return null;
            }

            try {
                const db = window.firebaseDb;
                const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                const taskToCreate = {
                    ...taskData,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                const docRef = await addDoc(collection(db, "todos"), taskToCreate);
                console.log("Task created with ID:", docRef.id);
                return { id: docRef.id, ...taskToCreate };
            } catch (error) {
                console.error("Error creating task:", error);
                showToast('Failed to create task', 'error');
                return null;
            }
        }

        // Update a task for the current user
        async function updateTaskForCurrentUser(taskId, updates) {
            if (!currentUser) {
                showToast('Please login to update tasks', 'error');
                return false;
            }

            try {
                const db = window.firebaseDb;
                const { doc, updateDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                const taskRef = doc(db, "todos", taskId);
                await updateDoc(taskRef, {
                    ...updates,
                    updatedAt: serverTimestamp()
                });

                console.log("Task updated:", taskId);
                return true;
            } catch (error) {
                console.error("Error updating task:", error);
                showToast('Failed to update task', 'error');
                return false;
            }
        }

        // Delete a task for the current user
        async function deleteTaskForCurrentUser(taskId) {
            if (!currentUser) {
                showToast('Please login to delete tasks', 'error');
                return false;
            }

            try {
                const db = window.firebaseDb;
                const { doc, deleteDoc } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                const taskRef = doc(db, "todos", taskId);
                await deleteDoc(taskRef);

                console.log("Task deleted:", taskId);
                return true;
            } catch (error) {
                console.error("Error deleting task:", error);
                showToast('Failed to delete task', 'error');
                return false;
            }
        }

        // Subscribe to tasks for the current user (real-time updates)
        function subscribeToTasksForCurrentUser(callback) {
            if (!currentUser) {
                console.log("No user logged in, cannot subscribe to tasks");
                return null;
            }

            // Unsubscribe from previous subscription if exists
            if (unsubscribeTasks) {
                unsubscribeTasks();
            }

            (async () => {
                try {
                    const db = window.firebaseDb;
                    const { collection, query, where, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js");

                    const q = query(
                        collection(db, "todos"),
                        where("userId", "==", currentUser.uid)
                    );

                    unsubscribeTasks = onSnapshot(q, (snapshot) => {
                        tasks = [];
                        snapshot.forEach((doc) => {
                            tasks.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });

                        console.log(`Loaded ${tasks.length} tasks from Firestore`);
                        callback(tasks);
                        updateStats();
                        updateStreakDisplay();
                    }, (error) => {
                        console.error("Error subscribing to tasks:", error);
                        showToast('Failed to load tasks', 'error');
                    });

                } catch (error) {
                    console.error("Error setting up task subscription:", error);
                    showToast('Failed to setup task sync', 'error');
                }
            })();
        }

        // OLD LOCAL STORAGE IMPLEMENTATION (no longer used for tasks)
        // function loadTasksFromStorage() {
        //     const stored = localStorage.getItem('todo_tasks');
        //     if (stored) {
        //         tasks = JSON.parse(stored);
        //         if (tasks.length > 0) {
        //             nextId = Math.max(...tasks.map(t => t.id)) + 1;
        //         }
        //     }
        // }

        // function saveTasksToStorage() {
        //     localStorage.setItem('todo_tasks', JSON.stringify(tasks));
        // }

        // Load streak data from localStorage
        function loadStreakData() {
            const stored = localStorage.getItem('todo_streak');
            if (stored) {
                streakData = JSON.parse(stored);
                checkStreakValidity();
            }
        }

        // Save streak data to localStorage
        function saveStreakData() {
            localStorage.setItem('todo_streak', JSON.stringify(streakData));
        }

        // Check if streak is still valid (reset if more than 1 day passed)
        function checkStreakValidity() {
            if (!streakData.lastCompletionDate) return;

            const today = new Date().toDateString();
            const lastDate = new Date(streakData.lastCompletionDate).toDateString();

            if (today !== lastDate) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toDateString();

                if (lastDate !== yesterdayStr) {
                    // Streak broken - more than 1 day passed
                    streakData.currentStreak = 0;
                }
                // Reset today's count
                streakData.todayCompletions = 0;
                saveStreakData();
            }
        }

        // Update streak when task is completed
        function updateStreak() {
            const today = new Date().toDateString();
            const lastDate = streakData.lastCompletionDate ? new Date(streakData.lastCompletionDate).toDateString() : null;

            if (today !== lastDate) {
                // First completion today
                streakData.currentStreak += 1;
                streakData.lastCompletionDate = new Date().toISOString();
                streakData.todayCompletions = 1;
            } else {
                // Additional completion today
                streakData.todayCompletions += 1;
            }

            saveStreakData();
            updateStreakDisplay();
        }

        // Update streak display in header
        function updateStreakDisplay() {
            const streakDisplay = document.getElementById('streakDisplay');
            const todayDisplay = document.getElementById('todayTasksDisplay');

            const streakText = streakData.currentStreak === 1 ? 'day' : 'days';
            streakDisplay.textContent = `üî• ${streakData.currentStreak} ${streakText} streak`;

            const taskText = streakData.todayCompletions === 1 ? 'task' : 'tasks';
            todayDisplay.textContent = `${streakData.todayCompletions} ${taskText} completed today`;
        }

        // Render tasks to the board
        function renderTasks() {
            // Clear all columns
            document.getElementById('todoColumn').innerHTML = '';
            document.getElementById('inProgressColumn').innerHTML = '';
            document.getElementById('doneColumn').innerHTML = '';

            // Apply filters
            const filteredTasks = filterTasks(tasks);

            // Filter and render tasks by status
            const todoTasks = filteredTasks.filter(t => t.status === 'todo');
            const inProgressTasks = filteredTasks.filter(t => t.status === 'in_progress');
            const doneTasks = filteredTasks.filter(t => t.status === 'done');

            // Render tasks or empty state
            if (todoTasks.length === 0) {
                renderEmptyState('todoColumn');
            } else {
                todoTasks.forEach(task => renderTask(task, 'todoColumn'));
            }

            if (inProgressTasks.length === 0) {
                renderEmptyState('inProgressColumn');
            } else {
                inProgressTasks.forEach(task => renderTask(task, 'inProgressColumn'));
            }

            if (doneTasks.length === 0) {
                renderEmptyState('doneColumn');
            } else {
                doneTasks.forEach(task => renderTask(task, 'doneColumn'));
            }

            // Update counters
            document.getElementById('todoCount').textContent = todoTasks.length;
            document.getElementById('inProgressCount').textContent = inProgressTasks.length;
            document.getElementById('doneCount').textContent = doneTasks.length;
        }

        // Render empty state for a column
        function renderEmptyState(columnId) {
            const column = document.getElementById(columnId);
            const emptyState = document.createElement('div');
            emptyState.className = 'text-center py-8 text-gray-400';
            emptyState.innerHTML = `
                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
                <p class="text-sm">No tasks yet</p>
            `;
            column.appendChild(emptyState);
        }

        // Render a single task card
        function renderTask(task, columnId) {
            const column = document.getElementById(columnId);
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-gray-50 border border-gray-200 rounded-lg p-4 cursor-move';
            taskCard.setAttribute('data-task-id', task.id);
            taskCard.setAttribute('draggable', 'true');

            // Add drag event listeners
            taskCard.addEventListener('dragstart', handleDragStart);
            taskCard.addEventListener('dragend', handleDragEnd);

            taskCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 cursor-pointer hover:text-blue-600 mb-1" onclick="openEditModal(${task.id})">${escapeHtml(task.title)}</h4>
                        <div class="flex gap-2 flex-wrap">
                            ${getPriorityBadge(task.priority || 'medium')}
                            ${getDueDateBadge(task.due_date, task.status)}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openEditModal(${task.id})" class="text-blue-500 hover:text-blue-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="deleteTask(${task.id})" class="text-red-500 hover:text-red-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
                ${task.description ? `<p class="text-sm text-gray-600 mb-3">${escapeHtml(task.description)}</p>` : ''}
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">${formatDate(task.created_at)}</span>
                    <div class="flex gap-2">
                        ${task.status !== 'todo' ? `
                            <button onclick="moveTask(${task.id}, 'todo')" class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded transition-colors">
                                ‚Üê To Do
                            </button>
                        ` : ''}
                        ${task.status === 'todo' ? `
                            <button onclick="moveTask(${task.id}, 'in_progress')" class="text-xs px-2 py-1 bg-blue-500 text-white hover:bg-blue-600 rounded transition-colors">
                                Start ‚Üí
                            </button>
                        ` : ''}
                        ${task.status === 'in_progress' ? `
                            <button onclick="moveTask(${task.id}, 'done')" class="text-xs px-2 py-1 bg-green-500 text-white hover:bg-green-600 rounded transition-colors">
                                Complete ‚Üí
                            </button>
                        ` : ''}
                        ${task.status === 'done' ? `
                            <button onclick="moveTask(${task.id}, 'in_progress')" class="text-xs px-2 py-1 bg-blue-200 hover:bg-blue-300 rounded transition-colors">
                                ‚Üê Resume
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            column.appendChild(taskCard);
        }

        // Handle add task form submission
        async function handleAddTask(e) {
            e.preventDefault();

            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const dueDate = document.getElementById('taskDueDate').value;
            const dueTime = document.getElementById('taskDueTime').value;

            if (!title) {
                showToast('Please enter a task title', 'error');
                return;
            }

            let dueDateTime = null;
            if (dueDate) {
                if (dueTime) {
                    dueDateTime = new Date(`${dueDate}T${dueTime}`).toISOString();
                } else {
                    dueDateTime = new Date(`${dueDate}T23:59`).toISOString();
                }
            }

            const taskData = {
                title,
                description: description || null,
                priority: priority || 'medium',
                status: 'todo',
                due_date: dueDateTime,
                notified: false
            };

            const createdTask = await createTaskForCurrentUser(taskData);

            if (createdTask) {
                // Clear form
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskDueTime').value = '';

                showToast('Task added successfully!', 'success');
            }
        }

        // Move task to different status
        async function moveTask(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const oldStatus = task.status;

            // Update in Firestore
            const success = await updateTaskForCurrentUser(taskId, { status: newStatus });

            if (success) {
                // Update streak when completing a task
                if (newStatus === 'done' && oldStatus !== 'done') {
                    updateStreak();
                    triggerConfetti();
                    showToast('Task completed! üéâ', 'success');
                } else {
                    showToast('Task moved successfully!', 'success');
                }
            }
        }

        // Trigger confetti animation
        function triggerConfetti() {
            const count = 200;
            const defaults = {
                origin: { y: 0.7 }
            };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, {
                spread: 26,
                startVelocity: 55,
            });

            fire(0.2, {
                spread: 60,
            });

            fire(0.35, {
                spread: 100,
                decay: 0.91,
                scalar: 0.8
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 25,
                decay: 0.92,
                scalar: 1.2
            });

            fire(0.1, {
                spread: 120,
                startVelocity: 45,
            });
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;

            const success = await deleteTaskForCurrentUser(taskId);

            if (success) {
                showToast('Task deleted successfully!', 'success');
            }
        }

        // Edit Task functionality
        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = document.getElementById('editModal');
            const editTaskId = document.getElementById('editTaskId');
            const editTaskTitle = document.getElementById('editTaskTitle');
            const editTaskDescription = document.getElementById('editTaskDescription');
            const editTaskPriority = document.getElementById('editTaskPriority');
            const editTaskDueDate = document.getElementById('editTaskDueDate');
            const editTaskDueTime = document.getElementById('editTaskDueTime');

            editTaskId.value = task.id;
            editTaskTitle.value = task.title;
            editTaskDescription.value = task.description || '';
            editTaskPriority.value = task.priority || 'medium';

            if (task.due_date) {
                const dueDate = new Date(task.due_date);
                editTaskDueDate.value = dueDate.toISOString().split('T')[0];
                editTaskDueTime.value = dueDate.toTimeString().slice(0, 5);
            } else {
                editTaskDueDate.value = '';
                editTaskDueTime.value = '';
            }

            modal.classList.remove('hidden');
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
        }

        async function handleEditTask(e) {
            e.preventDefault();

            const taskId = document.getElementById('editTaskId').value;
            const title = document.getElementById('editTaskTitle').value.trim();
            const description = document.getElementById('editTaskDescription').value.trim();
            const priority = document.getElementById('editTaskPriority').value;
            const dueDate = document.getElementById('editTaskDueDate').value;
            const dueTime = document.getElementById('editTaskDueTime').value;

            if (!title) {
                showToast('Please enter a task title', 'error');
                return;
            }

            let dueDateTime = null;
            if (dueDate) {
                if (dueTime) {
                    dueDateTime = new Date(`${dueDate}T${dueTime}`).toISOString();
                } else {
                    dueDateTime = new Date(`${dueDate}T23:59`).toISOString();
                }
            }

            const updates = {
                title,
                description: description || null,
                priority: priority || 'medium',
                due_date: dueDateTime,
                notified: false // Reset notification flag when due date changes
            };

            const success = await updateTaskForCurrentUser(taskId, updates);

            if (success) {
                closeEditModal();
                showToast('Task updated successfully!', 'success');
            }
        }

        // Drag and Drop functionality
        let draggedTaskId = null;

        function handleDragStart(e) {
            draggedTaskId = e.target.getAttribute('data-task-id');
            e.target.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.target.style.opacity = '1';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('column') || e.target.closest('.column')) {
                const column = e.target.classList.contains('column') ? e.target : e.target.closest('.column');
                column.classList.add('bg-blue-50');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('column') || e.target.closest('.column')) {
                const column = e.target.classList.contains('column') ? e.target : e.target.closest('.column');
                column.classList.remove('bg-blue-50');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const column = e.target.classList.contains('column') ? e.target : e.target.closest('.column');
            if (column) {
                column.classList.remove('bg-blue-50');

                const columnId = column.id;
                let newStatus;

                if (columnId === 'todoColumn') {
                    newStatus = 'todo';
                } else if (columnId === 'inProgressColumn') {
                    newStatus = 'in_progress';
                } else if (columnId === 'doneColumn') {
                    newStatus = 'done';
                }

                if (newStatus && draggedTaskId) {
                    moveTask(draggedTaskId, newStatus);
                }
            }

            return false;
        }

        // Setup drag and drop for columns
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.column');
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragenter', handleDragEnter);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        // Utility: Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;

            if (type === 'error') {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
            }

            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Utility: Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Utility: Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Utility: Get priority badge HTML
        function getPriorityBadge(priority) {
            const badges = {
                low: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">üü¢ Low</span>',
                medium: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">üü° Medium</span>',
                high: '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">üî¥ High</span>'
            };
            return badges[priority] || badges.medium;
        }

        // Badges/Achievements System
        function getAchievements() {
            const completedTasks = tasks.filter(t => t.status === 'done').length;
            const totalTasks = tasks.length;

            const achievements = [
                {
                    id: 'first_task',
                    name: 'Getting Started',
                    description: 'Complete your first task',
                    icon: 'üéØ',
                    unlocked: completedTasks >= 1,
                    progress: Math.min(completedTasks, 1),
                    target: 1
                },
                {
                    id: 'five_tasks',
                    name: 'Productivity Rookie',
                    description: 'Complete 5 tasks',
                    icon: '‚≠ê',
                    unlocked: completedTasks >= 5,
                    progress: Math.min(completedTasks, 5),
                    target: 5
                },
                {
                    id: 'ten_tasks',
                    name: 'Task Master',
                    description: 'Complete 10 tasks',
                    icon: 'üåü',
                    unlocked: completedTasks >= 10,
                    progress: Math.min(completedTasks, 10),
                    target: 10
                },
                {
                    id: 'twenty_five_tasks',
                    name: 'Productivity Pro',
                    description: 'Complete 25 tasks',
                    icon: 'üí´',
                    unlocked: completedTasks >= 25,
                    progress: Math.min(completedTasks, 25),
                    target: 25
                },
                {
                    id: 'fifty_tasks',
                    name: 'Task Legend',
                    description: 'Complete 50 tasks',
                    icon: 'üèÜ',
                    unlocked: completedTasks >= 50,
                    progress: Math.min(completedTasks, 50),
                    target: 50
                },
                {
                    id: 'three_day_streak',
                    name: 'Consistent',
                    description: 'Maintain a 3-day streak',
                    icon: 'üî•',
                    unlocked: streakData.currentStreak >= 3,
                    progress: Math.min(streakData.currentStreak, 3),
                    target: 3
                },
                {
                    id: 'seven_day_streak',
                    name: 'Week Warrior',
                    description: 'Maintain a 7-day streak',
                    icon: 'üí™',
                    unlocked: streakData.currentStreak >= 7,
                    progress: Math.min(streakData.currentStreak, 7),
                    target: 7
                },
                {
                    id: 'thirty_day_streak',
                    name: 'Month Master',
                    description: 'Maintain a 30-day streak',
                    icon: 'üëë',
                    unlocked: streakData.currentStreak >= 30,
                    progress: Math.min(streakData.currentStreak, 30),
                    target: 30
                },
                {
                    id: 'high_priority',
                    name: 'Priority Player',
                    description: 'Complete a high-priority task',
                    icon: 'üî¥',
                    unlocked: tasks.some(t => t.status === 'done' && t.priority === 'high'),
                    progress: tasks.some(t => t.status === 'done' && t.priority === 'high') ? 1 : 0,
                    target: 1
                },
                {
                    id: 'busy_day',
                    name: 'Busy Bee',
                    description: 'Complete 5 tasks in one day',
                    icon: 'üêù',
                    unlocked: streakData.todayCompletions >= 5,
                    progress: Math.min(streakData.todayCompletions, 5),
                    target: 5
                }
            ];

            return achievements;
        }

        function openBadgesModal() {
            const modal = document.getElementById('badgesModal');
            const content = document.getElementById('badgesContent');

            const achievements = getAchievements();
            const unlockedCount = achievements.filter(a => a.unlocked).length;

            content.innerHTML = achievements.map(achievement => `
                <div class="p-4 rounded-lg border-2 ${achievement.unlocked ? 'bg-gradient-to-br from-yellow-50 to-orange-50 border-yellow-300' : 'bg-gray-50 border-gray-200 opacity-60'}">
                    <div class="flex items-start gap-3">
                        <div class="text-4xl ${achievement.unlocked ? 'grayscale-0' : 'grayscale'}">${achievement.icon}</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg ${achievement.unlocked ? 'text-gray-900' : 'text-gray-500'}">${achievement.name}</h3>
                            <p class="text-sm text-gray-600 mb-2">${achievement.description}</p>
                            ${!achievement.unlocked ? `
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${(achievement.progress / achievement.target) * 100}%"></div>
                                </div>
                                <p class="text-xs text-gray-500">${achievement.progress} / ${achievement.target}</p>
                            ` : '<span class="text-xs font-semibold text-green-600">‚úì UNLOCKED</span>'}
                        </div>
                    </div>
                </div>
            `).join('');

            // Add summary at the top
            content.insertAdjacentHTML('afterbegin', `
                <div class="col-span-1 md:col-span-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-lg mb-2">
                    <h3 class="text-xl font-bold mb-2">Progress Summary</h3>
                    <p class="text-lg">${unlockedCount} / ${achievements.length} achievements unlocked</p>
                    <div class="w-full bg-white bg-opacity-30 rounded-full h-3 mt-2">
                        <div class="bg-white h-3 rounded-full transition-all duration-500" style="width: ${(unlockedCount / achievements.length) * 100}%"></div>
                    </div>
                </div>
            `);

            modal.classList.remove('hidden');
        }

        function closeBadgesModal() {
            const modal = document.getElementById('badgesModal');
            modal.classList.add('hidden');
        }

        // Theme System
        function loadTheme() {
            const savedTheme = localStorage.getItem('todo_theme') || 'light';
            setTheme(savedTheme, false);
        }

        function setTheme(theme, save = true) {
            const body = document.body;

            // Remove all theme classes
            body.classList.remove('dark-theme', 'minimal-theme');

            // Add new theme class
            if (theme === 'dark') {
                body.classList.add('dark-theme');
            } else if (theme === 'minimal') {
                body.classList.add('minimal-theme');
            }

            // Update checkmarks
            ['light', 'dark', 'minimal'].forEach(t => {
                const check = document.getElementById(`${t}-check`);
                if (check) {
                    if (t === theme) {
                        check.classList.remove('hidden');
                    } else {
                        check.classList.add('hidden');
                    }
                }
            });

            // Save to localStorage
            if (save) {
                localStorage.setItem('todo_theme', theme);
                showToast(`Theme changed to ${theme}!`, 'success');
                closeThemeModal();
            }
        }

        function openThemeModal() {
            const modal = document.getElementById('themeModal');
            modal.classList.remove('hidden');
        }

        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            modal.classList.add('hidden');
        }

        // Utility: Get due date badge HTML
        function getDueDateBadge(dueDate, status) {
            if (!dueDate || status === 'done') return '';

            const now = new Date();
            const due = new Date(dueDate);
            const diffMs = due - now;
            const diffHours = diffMs / (1000 * 60 * 60);

            let badgeClass = '';
            let icon = 'üìÖ';
            let text = '';

            if (diffMs < 0) {
                // Overdue
                badgeClass = 'bg-red-100 text-red-800 border border-red-300';
                icon = '‚ö†Ô∏è';
                const days = Math.ceil(Math.abs(diffMs) / (1000 * 60 * 60 * 24));
                text = days === 0 ? 'Overdue today' : `Overdue ${days}d`;
            } else if (diffHours < 24) {
                // Due today
                badgeClass = 'bg-orange-100 text-orange-800 border border-orange-300';
                icon = 'üîî';
                const hours = Math.ceil(diffHours);
                text = hours === 0 ? 'Due now' : `Due in ${hours}h`;
            } else if (diffHours < 48) {
                // Due tomorrow
                badgeClass = 'bg-yellow-100 text-yellow-800';
                icon = '‚è∞';
                text = 'Due tomorrow';
            } else {
                // Future
                badgeClass = 'bg-blue-100 text-blue-800';
                const days = Math.ceil(diffHours / 24);
                text = `Due in ${days}d`;
            }

            const dateStr = due.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

            return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${badgeClass}" title="${dateStr}">${icon} ${text}</span>`;
        }

        // Notification System
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showToast('Notifications enabled! You\'ll be alerted when tasks are due.', 'success');
                    }
                });
            }
        }

        function checkDueTasksAndNotify() {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }

            const now = new Date();

            tasks.forEach(task => {
                if (!task.due_date || task.status === 'done' || task.notified) {
                    return;
                }

                const dueDate = new Date(task.due_date);
                const timeDiff = dueDate - now;

                // Notify if task is due within 15 minutes or overdue
                if (timeDiff <= 15 * 60 * 1000 && timeDiff >= -60 * 60 * 1000) {
                    const notification = new Notification('Task Due: ' + task.title, {
                        body: task.description || 'This task is due soon!',
                        icon: 'üìã',
                        tag: `task-${task.id}`,
                        requireInteraction: true
                    });

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };

                    // Mark as notified
                    const index = tasks.findIndex(t => t.id === task.id);
                    if (index !== -1) {
                        tasks[index].notified = true;
                        saveTasksToStorage();
                    }
                }
            });
        }

        function startNotificationChecker() {
            // Check every minute
            setInterval(checkDueTasksAndNotify, 60 * 1000);
            // Also check immediately
            setTimeout(checkDueTasksAndNotify, 3000);
        }

        // Stats System
        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'done').length;
            const inProgress = tasks.filter(t => t.status === 'in_progress').length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statCompleted').textContent = completed;
            document.getElementById('statInProgress').textContent = inProgress;
            document.getElementById('statRate').textContent = rate + '%';
        }

        // Filter System
        function setupFilterListeners() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filters.search = e.target.value.toLowerCase();
                renderTasks();
            });

            document.getElementById('filterPriority').addEventListener('change', (e) => {
                filters.priority = e.target.value;
                renderTasks();
            });

            document.getElementById('filterStatus').addEventListener('change', (e) => {
                filters.status = e.target.value;
                renderTasks();
            });

            document.getElementById('filterQuick').addEventListener('change', (e) => {
                filters.quick = e.target.value;
                renderTasks();
            });
        }

        function filterTasks(taskList) {
            return taskList.filter(task => {
                // Search filter
                if (filters.search && !task.title.toLowerCase().includes(filters.search)) {
                    return false;
                }

                // Priority filter
                if (filters.priority !== 'all' && task.priority !== filters.priority) {
                    return false;
                }

                // Status filter
                if (filters.status !== 'all' && task.status !== filters.status) {
                    return false;
                }

                // Quick filters
                if (filters.quick !== 'all') {
                    if (filters.quick === 'today') {
                        if (!task.due_date) return false;
                        const due = new Date(task.due_date);
                        const today = new Date();
                        if (due.toDateString() !== today.toDateString()) return false;
                    } else if (filters.quick === 'overdue') {
                        if (!task.due_date || task.status === 'done') return false;
                        const due = new Date(task.due_date);
                        if (due > new Date()) return false;
                    } else if (filters.quick === 'upcoming') {
                        if (!task.due_date || task.status === 'done') return false;
                        const due = new Date(task.due_date);
                        const now = new Date();
                        const diffDays = (due - now) / (1000 * 60 * 60 * 24);
                        if (diffDays < 0 || diffDays > 7) return false;
                    }
                }

                return true;
            });
        }

        function clearFilters() {
            filters = {
                search: '',
                priority: 'all',
                status: 'all',
                quick: 'all'
            };

            document.getElementById('searchInput').value = '';
            document.getElementById('filterPriority').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            document.getElementById('filterQuick').value = 'all';

            renderTasks();
        }

        // Export/Import functionality removed - tasks are now stored in Firebase Firestore
    </script>
</body>
</html>
